<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voice Pok√©dex ‚Äî Offline</title>
  <style>
    :root { --bg:#0b1020; --card:#121a34; --accent:#6ee7ff; --muted:#8ea3c7; --good:#34d399; --bad:#f87171; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background: var(--bg); color:#e6eefc; }
    header { padding: 18px 20px; border-bottom: 1px solid #1e294f; position:sticky; top:0; background:linear-gradient(180deg, #0b1020 0%, rgba(11,16,32,.94) 100%); backdrop-filter: blur(6px); z-index: 2; }
    h1 { margin: 0; font-size: 22px; letter-spacing:.3px; }
    main { max-width: 1100px; margin: 0 auto; padding: 22px; display: grid; grid-template-columns: 320px 1fr; gap: 22px; }
    .card { background: var(--card); border:1px solid #1e294f; border-radius: 14px; padding: 16px; box-shadow: 0 8px 22px rgba(0,0,0,.25); }
    label { display:block; font-size: 12px; text-transform: uppercase; letter-spacing:.06em; color: var(--muted); margin-bottom: 6px; }
    input, select, button { width: 100%; padding: 12px 12px; border-radius: 10px; border:1px solid #2a396b; background:#0e1530; color:#eaf2ff; outline: none; }
    input::placeholder { color:#6072a1; }
    button { cursor: pointer; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .hint { color: var(--muted); font-size: 12px; margin-top: 8px; }
    .flex { display:flex; gap:10px; align-items:center; }
    .types { display:flex; gap:8px; flex-wrap:wrap; }
    .type { padding: 6px 10px; border-radius: 999px; font-size: 12px; border:1px solid #2a396b; background:#0f1734; }
    .pill { padding:4px 8px; border-radius: 999px; border:1px solid #2a396b; font-size:12px; color:var(--muted); }
    .result { display:grid; grid-template-columns: 120px 1fr; gap:16px; }
    .sprite { width: 110px; height:110px; image-rendering: pixelated; background:#0b1020; border:1px solid #27345f; border-radius: 14px; display:grid; place-items:center; }
    .grid { display:grid; grid-template-columns: repeat(3,minmax(0,1fr)); gap:10px; }
    .grid.two { grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); }
    .info-grid { grid-auto-rows: auto; }
    .stat { background:#0f1734; border:1px solid #2a396b; border-radius:10px; padding:10px; }
    .stat b { font-size: 18px; }
    .weak { color: var(--bad); }
    .res { color: var(--good); }
    .moves-list { display:flex; flex-direction:column; gap:4px; font-size:13px; line-height:1.3; }
    .moves-list span { background:#0b132b; border-radius:6px; padding:4px 6px; border:1px solid #1e294f; }
    .statline { margin-top:6px; font-size:13px; color: var(--muted); }
    .team { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .team .slot { width: 100%; }
    .rankings { display:grid; gap:10px; }
    .rank-item { background:#0f1734; border:1px solid #2a396b; border-radius:12px; padding:10px; display:flex; align-items:center; justify-content:space-between; }
    .rank-item .l { display:flex; align-items:center; gap:10px; }
    .rank-item .r { display:flex; flex-direction:column; gap:6px; align-items:flex-end; }
    .rank-item .r .top { display:flex; gap:6px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
    .dot { width:10px; height:10px; border-radius:50%; background:#6ee7ff; }
    .score { font-variant-numeric: tabular-nums; font-weight:700; }
    .hidden { display:none !important; }
    .voice-btn { display:flex; align-items:center; gap:8px; justify-content:center; }
    #voiceBtn.disabled { opacity: .5; cursor: not-allowed; }
    .mic { width: 10px; height: 20px; border-radius: 10px; border:2px solid #6ee7ff; position:relative; }
    .mic::after { content:""; position:absolute; bottom:-6px; left:50%; transform:translateX(-50%); width:12px; height:2px; background:#6ee7ff; }
    footer { max-width:1100px; margin: 0 auto 40px; padding: 0 22px; color: var(--muted); }
    a { color: var(--accent); }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0e1530; border:1px solid #2a396b; padding:2px 6px; border-radius:6px; }
    .team-moves { margin-top:6px; font-size:12px; color: var(--muted); display:flex; flex-direction:column; gap:2px; }
    .team-moves .label { font-weight:600; color:#e6eefc; margin-right:4px; text-transform:uppercase; letter-spacing:.04em; font-size:11px; }
    .team-moves.small { font-size:11px; text-align:right; }
    .team-moves.small .label { font-size:10px; }
    @media (max-width: 900px){ main { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>üéôÔ∏è Voice Pok√©dex (offline) ‚Äî weaknesses, resistances & team ranking</h1>
  </header>

  <main>
    <section class="card" aria-label="Controls">
      <div class="row" role="group" aria-label="Search">
        <div>
          <label for="nameInput">Pok√©mon name</label>
          <input id="nameInput" placeholder="e.g. Charizard" autocomplete="off" />
          <div class="hint">Type a name, pick from the list, or use voice.</div>
        </div>
        <div>
          <label for="nameSelect">Quick select</label>
          <select id="nameSelect" aria-label="Quick select Pok√©mon"></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="voiceBtn" class="voice-btn" aria-label="Hold to speak">
          <span class="mic" aria-hidden="true"></span>
          <span id="voiceLabel">Hold to speak</span>
        </button>
        <button id="showBtn">Show info</button>
      </div>

      <div class="hint" id="voiceHint">
        Voice tips: Press and hold the mic, say the name (e.g., <span class="kbd">pikachu</span>), release. Works best in Chrome / Edge.
      </div>

      <hr style="border-color:#1e294f; margin:14px 0; opacity:.5;"/>

      <div>
        <label>My team (pick up to 3)</label>
        <div class="team" id="teamSlots" aria-live="polite"></div>
        <div class="row" style="margin-top:10px;">
          <select id="teamSelect" aria-label="Add Pok√©mon to team"></select>
          <button id="addToTeamBtn">Add to team</button>
        </div>
        <div class="hint">Team is saved locally in your browser (no internet needed).</div>
      </div>
    </section>

    <section class="card" aria-label="Results">
      <div id="result" class="hidden">
        <div class="result">
          <div>
            <div class="sprite">
              <img id="sprite" alt="sprite" width="96" height="96" />
            </div>
          </div>
          <div>
            <h2 id="title" style="margin:0 0 6px 0"></h2>
            <div class="types" id="types"></div>
            <div style="margin-top:10px;" class="grid">
              <div class="stat"><div>Weak to</div><b class="weak" id="weakTo">‚Äì</b></div>
              <div class="stat"><div>Resists</div><b class="res" id="resists">‚Äì</b></div>
              <div class="stat"><div>Immune to</div><b id="immune">‚Äì</b></div>
            </div>
            <div style="margin-top:10px;" class="grid two info-grid">
              <div class="stat"><div>GO Stats</div><div id="goStats" class="statline">‚Äì</div></div>
              <div class="stat"><div>Fast attacks</div><div class="moves-list" id="fastMoves">‚Äì</div></div>
              <div class="stat"><div>Charged attacks</div><div class="moves-list" id="chargedMoves">‚Äì</div></div>
            </div>
          </div>
        </div>
        <h3 style="margin:16px 0 6px 0">My Team vs <span id="vsName"></span></h3>
        <div id="rankings" class="rankings"></div>
      </div>
      <div id="emptyState" class="hint">Choose a Pok√©mon to see its matchups.</div>
    </section>
  </main>

  <footer>
    <p><b>Offline data:</b> This page looks for <span class="kbd">data/pokemon.min.json</span> and local sprites in <span class="kbd">sprites/</span> (e.g. <span class="kbd">sprites/006.png</span>). If not found, it falls back to a tiny built-in sample so you can test instantly. Replace the JSON with a full dataset for all Pok√©mon.</p>
    <p class="hint">Voice search works in the browser build (Chrome/Edge). The desktop app runs fully offline but does not include voice input.</p>
  </footer>

  <script>
  // ------------------ Type Chart (attack -> defense multiplier) ------------------
  const TYPES = [
    'normal','fire','water','electric','grass','ice','fighting','poison','ground','flying','psychic','bug','rock','ghost','dragon','dark','steel','fairy'
  ];
  const TYPE_CHART = {
    normal:   { rock:.5, ghost:0, steel:.5 },
    fire:     { fire:.5, water:.5, grass:2, ice:2, bug:2, rock:.5, dragon:.5, steel:2 },
    water:    { fire:2, water:.5, grass:.5, ground:2, rock:2, dragon:.5 },
    electric: { water:2, electric:.5, grass:.5, ground:0, flying:2, dragon:.5 },
    grass:    { fire:.5, water:2, grass:.5, poison:.5, ground:2, flying:.5, bug:.5, rock:2, dragon:.5, steel:.5 },
    ice:      { fire:.5, water:.5, grass:2, ground:2, flying:2, dragon:2, steel:.5 },
    fighting: { normal:2, ice:2, rock:2, dark:2, steel:2, poison:.5, flying:.5, psychic:.5, bug:.5, fairy:.5, ghost:0 },
    poison:   { grass:2, poison:.5, ground:.5, rock:.5, ghost:.5, steel:0, fairy:2 },
    ground:   { fire:2, electric:2, grass:.5, poison:2, flying:0, bug:.5, rock:2, steel:2 },
    flying:   { electric:.5, grass:2, fighting:2, bug:2, rock:.5, steel:.5 },
    psychic:  { fighting:2, poison:2, psychic:.5, dark:0, steel:.5 },
    bug:      { fire:.5, grass:2, fighting:.5, poison:.5, flying:.5, psychic:2, ghost:.5, dark:2, steel:.5, fairy:.5 },
    rock:     { fire:2, ice:2, fighting:.5, ground:.5, flying:2, bug:2, steel:.5 },
    ghost:    { normal:0, psychic:2, dark:.5 },
    dragon:   { dragon:2, steel:.5, fairy:0 },
    dark:     { fighting:.5, psychic:2, ghost:2, dark:.5, fairy:.5 },
    steel:    { fire:.5, water:.5, electric:.5, ice:2, rock:2, fairy:2, steel:.5 },
    fairy:    { fire:.5, fighting:2, poison:.5, dragon:2, dark:2, steel:.5 }
  };

  function effectiveness(attackType, defendTypes){
    let mult = 1;
    const rules = TYPE_CHART[attackType] || {};
    for (const dt of defendTypes){
      const m = rules[dt];
      if (m === 0) return 0; // immunity dominates
      if (m) mult *= m;
    }
    return mult;
  }
  function defendMultipliers(defendTypes){
    const out = {};
    for (const atk of TYPES) out[atk] = effectiveness(atk, defendTypes);
    return out;
  }

  function buildSampleMove(id, name, type, category, power, energy, cooldown){
    const move = { id, name, type, category, power, energy };
    if (typeof cooldown === 'number' && cooldown > 0){
      move.cooldown = Number(cooldown.toFixed(2));
      move.turns = Number((cooldown / 0.5).toFixed(2));
      if (typeof power === 'number'){
        move.dps = Number((power / cooldown).toFixed(2));
      }
      if (typeof energy === 'number'){
        move.eps = Number((energy / cooldown).toFixed(2));
      }
    }
    if (category === 'charged' && typeof power === 'number' && typeof energy === 'number' && energy !== 0){
      move.dpe = Number((power / Math.abs(energy)).toFixed(2));
    }
    return move;
  }

  // ------------------ Minimal Sample Data (fallback) ------------------
  const SAMPLE_DATA = [
    {
      dex:1,
      name:"Bulbasaur",
      slug:"bulbasaur",
      types:["grass","poison"],
      stats:{attack:118,defense:111,stamina:128},
      moves:{
        fast:[
          buildSampleMove('VINE_WHIP','Vine Whip (Fast)','grass','fast',5,8,0.6),
          buildSampleMove('TACKLE','Tackle (Fast)','normal','fast',4,5,0.5)
        ],
        charged:[
          buildSampleMove('POWER_WHIP','Power Whip','grass','charged',90,-50),
          buildSampleMove('SEED_BOMB','Seed Bomb','grass','charged',60,-45),
          buildSampleMove('SLUDGE_BOMB','Sludge Bomb','poison','charged',80,-50)
        ],
        recommended:{fast:'VINE_WHIP',charged:['POWER_WHIP','SLUDGE_BOMB']}
      }
    },
    {
      dex:4,
      name:"Charmander",
      slug:"charmander",
      types:["fire"],
      stats:{attack:116,defense:93,stamina:118},
      moves:{
        fast:[
          buildSampleMove('EMBER','Ember (Fast)','fire','fast',6,6,1.0),
          buildSampleMove('SCRATCH','Scratch (Fast)','normal','fast',4,2,0.5)
        ],
        charged:[
          buildSampleMove('FLAME_BURST','Flame Burst','fire','charged',70,-50),
          buildSampleMove('FLAME_CHARGE','Flame Charge','fire','charged',70,-45),
          buildSampleMove('FLAMETHROWER','Flamethrower','fire','charged',90,-55)
        ],
        recommended:{fast:'EMBER',charged:['FLAME_CHARGE','FLAMETHROWER']}
      }
    },
    {
      dex:6,
      name:"Charizard",
      slug:"charizard",
      types:["fire","flying"],
      stats:{attack:223,defense:173,stamina:186},
      moves:{
        fast:[
          buildSampleMove('AIR_SLASH','Air Slash (Fast)','flying','fast',9,9,1.2),
          buildSampleMove('FIRE_SPIN','Fire Spin (Fast)','fire','fast',9,10,1.1)
        ],
        charged:[
          buildSampleMove('BLAST_BURN','Blast Burn','fire','charged',110,-50),
          buildSampleMove('DRAGON_CLAW','Dragon Claw','dragon','charged',50,-35),
          buildSampleMove('OVERHEAT','Overheat','fire','charged',160,-65)
        ],
        recommended:{fast:'FIRE_SPIN',charged:['BLAST_BURN','DRAGON_CLAW']}
      }
    },
    {
      dex:7,
      name:"Squirtle",
      slug:"squirtle",
      types:["water"],
      stats:{attack:94,defense:121,stamina:127},
      moves:{
        fast:[
          buildSampleMove('BUBBLE','Bubble (Fast)','water','fast',7,11,1.2),
          buildSampleMove('TACKLE','Tackle (Fast)','normal','fast',4,5,0.5)
        ],
        charged:[
          buildSampleMove('AQUA_JET','Aqua Jet','water','charged',45,-45),
          buildSampleMove('AQUA_TAIL','Aqua Tail','water','charged',50,-35),
          buildSampleMove('WATER_PULSE','Water Pulse','water','charged',70,-60)
        ],
        recommended:{fast:'BUBBLE',charged:['AQUA_TAIL','AQUA_JET']}
      }
    },
    {
      dex:25,
      name:"Pikachu",
      slug:"pikachu",
      types:["electric"],
      stats:{attack:112,defense:96,stamina:111},
      moves:{
        fast:[
          buildSampleMove('QUICK_ATTACK','Quick Attack (Fast)','normal','fast',5,8,0.8),
          buildSampleMove('THUNDER_SHOCK','Thunder Shock (Fast)','electric','fast',3,9,0.6)
        ],
        charged:[
          buildSampleMove('DISCHARGE','Discharge','electric','charged',65,-45),
          buildSampleMove('THUNDER','Thunder','electric','charged',100,-60),
          buildSampleMove('WILD_CHARGE','Wild Charge','electric','charged',100,-45)
        ],
        recommended:{fast:'THUNDER_SHOCK',charged:['WILD_CHARGE','THUNDER']}
      }
    },
    {
      dex:94,
      name:"Gengar",
      slug:"gengar",
      types:["ghost","poison"],
      stats:{attack:261,defense:149,stamina:155},
      moves:{
        fast:[
          buildSampleMove('HEX','Hex (Fast)','ghost','fast',8,12,1.0),
          buildSampleMove('SUCKER_PUNCH','Sucker Punch (Fast)','dark','fast',7,8,1.5)
        ],
        charged:[
          buildSampleMove('SHADOW_BALL','Shadow Ball','ghost','charged',100,-55),
          buildSampleMove('SHADOW_PUNCH','Shadow Punch','ghost','charged',55,-35),
          buildSampleMove('SLUDGE_BOMB','Sludge Bomb','poison','charged',80,-50)
        ],
        recommended:{fast:'HEX',charged:['SHADOW_BALL','SHADOW_PUNCH']}
      }
    },
    {
      dex:149,
      name:"Dragonite",
      slug:"dragonite",
      types:["dragon","flying"],
      stats:{attack:263,defense:198,stamina:209},
      moves:{
        fast:[
          buildSampleMove('DRAGON_BREATH','Dragon Breath (Fast)','dragon','fast',4,3,0.5),
          buildSampleMove('STEEL_WING','Steel Wing (Fast)','steel','fast',11,6,1.4)
        ],
        charged:[
          buildSampleMove('DRAGON_CLAW','Dragon Claw','dragon','charged',50,-35),
          buildSampleMove('DRAGON_PULSE','Dragon Pulse','dragon','charged',90,-60),
          buildSampleMove('HURRICANE','Hurricane','flying','charged',110,-65)
        ],
        recommended:{fast:'DRAGON_BREATH',charged:['DRAGON_CLAW','HURRICANE']}
      }
    },
    {
      dex:131,
      name:"Lapras",
      slug:"lapras",
      types:["water","ice"],
      stats:{attack:165,defense:174,stamina:277},
      moves:{
        fast:[
          buildSampleMove('FROST_BREATH','Frost Breath (Fast)','ice','fast',10,8,1.1),
          buildSampleMove('WATER_GUN','Water Gun (Fast)','water','fast',5,5,0.5)
        ],
        charged:[
          buildSampleMove('BLIZZARD','Blizzard','ice','charged',130,-75),
          buildSampleMove('ICE_BEAM','Ice Beam','ice','charged',90,-55),
          buildSampleMove('SURF','Surf','water','charged',65,-40)
        ],
        recommended:{fast:'WATER_GUN',charged:['SURF','ICE_BEAM']}
      }
    },
    {
      dex:143,
      name:"Snorlax",
      slug:"snorlax",
      types:["normal"],
      stats:{attack:190,defense:169,stamina:330},
      moves:{
        fast:[
          buildSampleMove('LICK','Lick (Fast)','ghost','fast',4,3,0.5),
          buildSampleMove('ZEN_HEADBUTT','Zen Headbutt (Fast)','psychic','fast',11,9,1.1)
        ],
        charged:[
          buildSampleMove('BODY_SLAM','Body Slam','normal','charged',60,-35),
          buildSampleMove('EARTHQUAKE','Earthquake','ground','charged',120,-65),
          buildSampleMove('HYPER_BEAM','Hyper Beam','normal','charged',150,-80)
        ],
        recommended:{fast:'LICK',charged:['BODY_SLAM','EARTHQUAKE']}
      }
    },
    {
      dex:212,
      name:"Scizor",
      slug:"scizor",
      types:["bug","steel"],
      stats:{attack:236,defense:181,stamina:172},
      moves:{
        fast:[
          buildSampleMove('BULLET_PUNCH','Bullet Punch (Fast)','steel','fast',9,7,1.0),
          buildSampleMove('FURY_CUTTER','Fury Cutter (Fast)','bug','fast',3,6,0.4)
        ],
        charged:[
          buildSampleMove('IRON_HEAD','Iron Head','steel','charged',70,-50),
          buildSampleMove('NIGHT_SLASH','Night Slash','dark','charged',50,-35),
          buildSampleMove('X_SCISSOR','X-Scissor','bug','charged',45,-35)
        ],
        recommended:{fast:'BULLET_PUNCH',charged:['NIGHT_SLASH','IRON_HEAD']}
      }
    }
  ];
  let POKEMON = SAMPLE_DATA;

  async function tryLoadExternalData(){
    try {
      const res = await fetch('data/pokemon.min.json');
      if (!res.ok) return;
      const json = await res.json();
      if (Array.isArray(json) && json.length) {
        POKEMON = json;
        console.log(`Loaded external dataset with ${json.length} Pok√©mon.`);
      }
    } catch(e){ console.warn('Using built-in sample data.', e); }
  }

  // ------------------ UI Refs ------------------
  const nameInput  = document.getElementById('nameInput');
  const nameSelect = document.getElementById('nameSelect');
  const teamSelect = document.getElementById('teamSelect');
  const addToTeamBtn = document.getElementById('addToTeamBtn');
  const teamSlots = document.getElementById('teamSlots');
  const voiceBtn = document.getElementById('voiceBtn');
  const voiceLabel = document.getElementById('voiceLabel');
  const voiceHintEl = document.getElementById('voiceHint');
  const showBtn = document.getElementById('showBtn');
  const resultEl = document.getElementById('result');
  const emptyState = document.getElementById('emptyState');
  const titleEl = document.getElementById('title');
  const typesEl = document.getElementById('types');
  const weakEl = document.getElementById('weakTo');
  const resEl = document.getElementById('resists');
  const immEl = document.getElementById('immune');
  const fastMovesEl = document.getElementById('fastMoves');
  const chargedMovesEl = document.getElementById('chargedMoves');
  const statsEl = document.getElementById('goStats');
  const spriteEl = document.getElementById('sprite');
  const vsName = document.getElementById('vsName');
  const rankingsEl = document.getElementById('rankings');

  // ------------------ Helpers ------------------
  function byName(name){
    name = (name || '').toString().trim().toLowerCase();
    if (!name) return null;
    let p = POKEMON.find(x => x.name.toLowerCase() === name);
    if (p) return p;
    p = POKEMON.find(x => x.name.toLowerCase().startsWith(name)) || POKEMON.find(x => x.name.toLowerCase().includes(name));
    return p || null;
  }
  function formatTypes(types){ return types.map(t=>`<span class="type">${t}</span>`).join(''); }
  function listFromMults(m){
    const entries = Object.entries(m);
    const weak = entries.filter(([,v])=>v>1).sort((a,b)=>b[1]-a[1]).map(([t,v])=>`${t}√ó${v}`);
    const res = entries.filter(([,v])=>v>0 && v<1).sort((a,b)=>a[1]-b[1]).map(([t,v])=>`${t}√ó${v}`);
    const imm = entries.filter(([,v])=>v===0).map(([t])=>t);
    return {weak, res, imm};
  }
  function normalizeMove(move){
    if (!move) return null;
    if (typeof move === 'string'){ return { id: move, name: move, category: 'unknown' }; }
    const copy = {...move};
    if (copy.id) copy.id = String(copy.id);
    if (copy.name) copy.name = String(copy.name);
    if (copy.type) copy.type = String(copy.type).toLowerCase();
    if (!copy.id && copy.name){ copy.id = copy.name.toUpperCase().replace(/[^A-Z0-9]+/g,'_'); }
    return copy;
  }
  function getMoveCache(p){
    if (!p) return {fast:[], charged:[]};
    if (!p._moveCache){
      const fast = (p.moves?.fast || []).map(normalizeMove).filter(Boolean);
      const charged = (p.moves?.charged || []).map(normalizeMove).filter(Boolean);
      p._moveCache = {fast, charged};
    }
    return p._moveCache;
  }
  function describeMove(move){
    if (!move) return '‚Äì';
    const name = typeof move === 'string' ? move : (move.name || move.id || 'Unknown move');
    const type = typeof move === 'object' && move?.type ? move.type : '';
    return type ? `${name} ¬∑ ${type}` : name;
  }
  function findMove(moves, key){
    if (!key) return null;
    const raw = String(key);
    const upper = raw.toUpperCase();
    for (const m of moves){
      if (m.id && (m.id === raw || m.id === upper)) return m;
    }
    const lower = raw.toLowerCase();
    return moves.find(m => (m.name && m.name.toLowerCase() === lower)) || null;
  }
  function getRecommendedMoveset(p){
    const pool = getMoveCache(p);
    const rec = p.moves?.recommended || {};
    let fast = null;
    if (rec.fast) fast = findMove(pool.fast, rec.fast);
    if (!fast) fast = pool.fast[0] || null;
    let charged = [];
    if (Array.isArray(rec.charged)){
      charged = rec.charged.map(id=>findMove(pool.charged, id)).filter(Boolean);
    }
    if (!charged.length) charged = pool.charged.slice(0,2);
    return {fast, charged, pool};
  }
  function powerScore(p){
    const s = p.stats || {};
    return (s.attack || 0) * 0.6 + (s.defense || 0) * 0.25 + (s.stamina || 0) * 0.15;
  }
  function stabBonus(attacker, moveType){
    return moveType && attacker.types?.includes(moveType) ? 1.2 : 1;
  }
  function moveMultiplier(moveType, defenderTypes){
    return moveType ? effectiveness(moveType, defenderTypes) : 1;
  }
  function scoreFastMove(move, attacker, defenderTypes){
    if (!move) return {score:0.5, mult:1, move:null};
    const mult = moveMultiplier(move.type, defenderTypes) * stabBonus(attacker, move.type);
    const cooldown = typeof move.cooldown === 'number' ? move.cooldown : (typeof move.cooldown_s === 'number' ? move.cooldown_s : null);
    let dps = typeof move.dps === 'number' ? move.dps : null;
    if (!dps && typeof move.power === 'number' && cooldown){ dps = move.power / cooldown; }
    if (!dps) dps = typeof move.power === 'number' ? move.power : 1;
    let eps = typeof move.eps === 'number' ? move.eps : null;
    if (!eps && typeof move.energy === 'number' && cooldown){ eps = move.energy / cooldown; }
    if (!eps) eps = typeof move.energy === 'number' ? move.energy : 0;
    const pressure = dps * 0.65 + eps * 0.35;
    return {score: pressure * mult, mult, move};
  }
  function scoreChargedMove(move, attacker, defenderTypes){
    if (!move) return {score:0.5, mult:1, move:null};
    const mult = moveMultiplier(move.type, defenderTypes) * stabBonus(attacker, move.type);
    const energyCost = Math.max(10, Math.abs(move.energy || 50));
    let dpe = typeof move.dpe === 'number' ? move.dpe : null;
    if (!dpe && typeof move.power === 'number'){ dpe = move.power / energyCost; }
    const powerBonus = 1 + (move.power || 0) / 200;
    const speedBonus = 1 + 40 / Math.max(35, energyCost);
    return {score: dpe * mult * powerBonus * speedBonus, mult, move};
  }
  function evaluatePokemonAgainst(attacker, defender){
    const {fast, charged} = getRecommendedMoveset(attacker);
    const defenderTypes = defender.types || [];
    const fastResult = scoreFastMove(fast, attacker, defenderTypes);
    const chargedResults = charged.map(m=>scoreChargedMove(m, attacker, defenderTypes));
    const bestCharged = chargedResults.sort((a,b)=>b.score-a.score)[0] || null;
    const coverage = new Set();
    if (fast?.type) coverage.add(fast.type);
    charged.forEach(m=>{ if (m?.type) coverage.add(m.type); });
    const coverageBonus = 1 + coverage.size * 0.03;
    const bulkBonus = 1 + powerScore(attacker)/400;
    const fastScore = fastResult.score;
    const chargedScore = bestCharged ? bestCharged.score : fastScore;
    const combined = (fastScore * 0.45 + chargedScore * 0.55) * coverageBonus * bulkBonus;
    const bestResult = !bestCharged || fastResult.score >= bestCharged.score ? fastResult : bestCharged;
    return {
      name: attacker.name,
      dex: attacker.dex,
      score: combined,
      mult: bestResult?.mult || 1,
      bestMove: bestResult?.move || null,
      bestMoveKind: bestResult === fastResult ? 'fast' : 'charged',
      fastMove: fast,
      chargedMoves: charged,
      types: attacker.types || [],
    };
  }
  function rankTeamAgainst(defender){
    const team = getTeam().map(name=>POKEMON.find(p=>p.name===name)).filter(Boolean);
    return team.map(p => evaluatePokemonAgainst(p, defender)).sort((a,b)=>b.score-a.score);
  }
  function setSprite(imgEl, dex){
    const num = String(dex).padStart(3,'0');
    imgEl.src = `sprites/${num}.png`;
    imgEl.onerror = ()=>{ imgEl.src = ''; imgEl.alt = 'No local sprite'; };
  }
  function renderMoves(el, moves){
    if (!moves || !moves.length){ el.innerHTML = '‚Äì'; return; }
    el.innerHTML = moves.map(m=>`<span>${describeMove(m)}</span>`).join('');
  }

  // ------------------ Render ------------------
  function showPokemon(p){
    if (!p){ resultEl.classList.add('hidden'); emptyState.classList.remove('hidden'); return; }
    resultEl.classList.remove('hidden'); emptyState.classList.add('hidden');
    titleEl.textContent = `${p.name} #${String(p.dex).padStart(3,'0')}`;
    typesEl.innerHTML = formatTypes(p.types);
    setSprite(spriteEl, p.dex);
    const mults = defendMultipliers(p.types);
    const {weak,res,imm} = listFromMults(mults);
    weakEl.textContent = weak.join(', ') || '‚Äì';
    resEl.textContent = res.join(', ') || '‚Äì';
    immEl.textContent = imm.join(', ') || '‚Äì';
    const stats = p.stats || {};
    statsEl.textContent = stats.attack ? `ATK ${stats.attack} ¬∑ DEF ${stats.defense} ¬∑ STA ${stats.stamina}` : '‚Äì';
    const movePool = getMoveCache(p);
    renderMoves(fastMovesEl, movePool.fast);
    renderMoves(chargedMovesEl, movePool.charged);
    vsName.textContent = p.name;
    renderRankings(rankTeamAgainst(p));
  }
  function renderRankings(rows){
    rankingsEl.innerHTML = '';
    if (!rows.length){
      const div = document.createElement('div');
      div.className = 'hint';
      div.textContent = 'Add Pok√©mon to your team to see rankings.';
      rankingsEl.appendChild(div);
      return;
    }
    rows.forEach((r,i)=>{
      const el = document.createElement('div');
      el.className = 'rank-item';
      const bestLabel = r.bestMoveKind === 'charged' ? 'Best charged' : 'Best fast';
      const bestMoveText = describeMove(r.bestMove);
      const fastText = describeMove(r.fastMove);
      const chargedText = (r.chargedMoves && r.chargedMoves.length) ? r.chargedMoves.map(describeMove).join(', ') : '‚Äì';
      el.innerHTML = `
        <div class="l">
          <div class="dot" style="opacity:${1 - i*0.2}"></div>
          <div>
            <b>${i+1}. ${r.name}</b>
            <div class="types">${formatTypes(r.types)}</div>
          </div>
        </div>
        <div class="r">
          <div class="top">
            <span class="pill">${bestLabel}: ${bestMoveText}</span>
            <span class="pill">x${r.mult.toFixed(2)}</span>
            <span class="score">${r.score.toFixed(1)}</span>
          </div>
          <div class="team-moves small">
            <div><span class="label">Fast</span>${fastText}</div>
            <div><span class="label">Charged</span>${chargedText}</div>
          </div>
        </div>`;
      rankingsEl.appendChild(el);
    });
  }
  function populateSelectors(){
    const sorted = [...POKEMON].sort((a,b)=>a.name.localeCompare(b.name));
    for (const sel of [nameSelect, teamSelect]){
      sel.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = '‚Äî choose ‚Äî';
      sel.appendChild(opt0);
      sorted.forEach(p=>{
        const o = document.createElement('option');
        o.value = p.name; o.textContent = p.name; sel.appendChild(o);
      });
    }
  }
  function getTeam(){
    try { return JSON.parse(localStorage.getItem('team3')||'[]'); } catch { return []; }
  }
  function setTeam(arr){
    try { localStorage.setItem('team3', JSON.stringify(arr.slice(0,3))); } catch {}
    renderTeam();
  }
  function renderTeam(){
    const t = getTeam();
    teamSlots.innerHTML = '';
    for (let i=0;i<3;i++){
      const name = t[i];
      const slot = document.createElement('div');
      slot.className = 'slot';
      if (name){
        const p = POKEMON.find(x=>x.name===name);
        const idp = p ? String(p.dex).padStart(3,'0') : '000';
        const moveset = p ? getRecommendedMoveset(p) : {fast:null, charged:[]};
        const fastText = p ? describeMove(moveset.fast) : '‚Äì';
        const chargedText = p ? (moveset.charged.length ? moveset.charged.map(describeMove).join(', ') : '‚Äì') : '‚Äì';
        const typeHtml = p ? formatTypes(p.types) : '';
        slot.innerHTML = `
          <div style="display:flex; align-items:flex-start; gap:8px;">
            <img alt="" width="40" height="40" style="image-rendering:pixelated; border-radius:8px; border:1px solid #27345f; background:#091022;" onerror="this.style.opacity=.3" src="sprites/${idp}.png"/>
            <div style="flex:1;">
              <b>${p ? p.name : name}</b>
              <div class="types">${typeHtml}</div>
              <div class="team-moves">
                <div><span class="label">Fast</span>${fastText}</div>
                <div><span class="label">Charged</span>${chargedText}</div>
              </div>
            </div>
            <button style="margin-left: auto; width:auto; padding:6px 10px;" onclick="removeFromTeam(${i})">Remove</button>
          </div>`;
      } else {
        slot.textContent = 'Empty';
      }
      teamSlots.appendChild(slot);
    }
  }
  function removeFromTeam(i){
    const t = getTeam();
    t.splice(i,1);
    setTeam(t);
  }
  window.removeFromTeam = removeFromTeam; // expose for inline onclick

  // ------------------ Voice (Electron disabled) ------------------
  let rec; let recActive = false;
  function setupVoice(){
    const R = window.SpeechRecognition || window.webkitSpeechRecognition;
    const isElectron = typeof navigator !== 'undefined' && /Electron/i.test(navigator.userAgent || '');
    // Update hint text
    if (voiceHintEl){
      voiceHintEl.textContent = isElectron
        ? 'Voice search is unavailable in the desktop app. Use typing or the dropdown.'
        : 'Voice tips: Press and hold the mic, say the name (e.g., pikachu), release. Works best in Chrome / Edge.';
    }
    // Disable if Electron OR unsupported
    if (isElectron || !R){
      voiceBtn.disabled = true;
      voiceBtn.classList.add('disabled');
      voiceBtn.title = isElectron
        ? 'Voice search isn‚Äôt available in the desktop app'
        : 'Speech recognition not supported in this browser';
      voiceLabel.textContent = isElectron ? 'Unavailable in desktop app' : 'Not supported';
      return;
    }
    // Browser speech setup
    rec = new R();
    rec.lang = 'en-US';
    rec.interimResults = false;
    rec.maxAlternatives = 4;
    rec.onresult = (e)=>{
      const alts = [];
      for (const r of e.results){ for (const a of r){ alts.push(a.transcript); } }
      let found = null;
      for (const t of alts){ found = byName(t); if (found) break; }
      if (!found){
        const cleaned = alts.map(s=>s.toLowerCase().replace(/[^a-z0-9 ]/g,'').trim());
        for (const t of cleaned){ found = byName(t); if (found) break; }
      }
      if (found){
        nameInput.value = found.name; nameSelect.value = found.name;
        showPokemon(found);
      } else {
        alert('Did not catch that name. Try again or type/select.');
      }
    };
    rec.onend = ()=>{
      recActive=false; voiceLabel.textContent='Hold to speak'; voiceBtn.classList.remove('rec');
    };
    const startRec = ()=>{ if (recActive) return; recActive=true; voiceLabel.textContent='Listening‚Ä¶'; voiceBtn.classList.add('rec'); rec.start(); };
    const stopRec  = ()=>{ if (!recActive) return; rec.stop(); };
    voiceBtn.onmousedown = startRec;
    voiceBtn.onmouseup = stopRec;
    voiceBtn.onmouseleave = stopRec;
    // Touch support
    voiceBtn.ontouchstart = (e)=>{ e.preventDefault(); startRec(); };
    voiceBtn.ontouchend = (e)=>{ e.preventDefault(); stopRec(); };
  }

  // ------------------ Events ------------------
  showBtn.onclick = ()=>{
    const name = nameInput.value || nameSelect.value;
    const p = byName(name);
    if (!p){ alert('Pick a valid Pok√©mon name.'); return; }
    nameSelect.value = p.name; nameInput.value = p.name;
    showPokemon(p);
  };
  nameSelect.onchange = ()=>{
    const v = nameSelect.value; if (!v) return; nameInput.value = v; const p=byName(v); showPokemon(p);
  };
  addToTeamBtn.onclick = ()=>{
    const sel = teamSelect.value; if (!sel) return;
    const t = getTeam();
    if (t.includes(sel)) return alert('Already on team.');
    if (t.length >= 3) return alert('Team is full (max 3). Remove one first.');
    t.push(sel); setTeam(t);
  };

  // ------------------ Boot ------------------
  (async function(){
    await tryLoadExternalData();
    populateSelectors();
    renderTeam();
    setupVoice();
  })();
  </script>
</body>
</html>
