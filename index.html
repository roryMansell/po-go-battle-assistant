<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voice Pokédex — Offline</title>
  <style>
    :root {
      --bg: #050a17;
      --bg-alt: #0f162c;
      --card: rgba(16, 24, 48, 0.92);
      --card-border: rgba(86, 112, 180, 0.45);
      --accent: #6ee7ff;
      --accent-strong: #4f9dff;
      --muted: #8ea3c7;
      --good: #34d399;
      --bad: #f87171;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", Roboto, "Helvetica Neue", Arial, system-ui, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(110, 231, 255, 0.18), transparent 45%),
                  radial-gradient(circle at 80% 10%, rgba(79, 157, 255, 0.16), transparent 42%),
                  linear-gradient(160deg, #040812 0%, #0b1326 100%);
      color: #f2f6ff;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 15% 75%, rgba(94, 234, 212, 0.08), transparent 55%),
                  radial-gradient(circle at 90% 80%, rgba(110, 231, 255, 0.12), transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    header {
      padding: 24px 22px 10px;
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(180deg, rgba(5, 10, 23, 0.96) 0%, rgba(5, 10, 23, 0.72) 75%, transparent 100%);
      backdrop-filter: blur(18px);
    }
    header h1 {
      margin: 0 auto;
      max-width: 1200px;
      font-size: 24px;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    header h1::after {
      content: "";
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, rgba(110, 231, 255, 0.3), transparent);
      margin-left: 12px;
    }
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 22px 48px;
      display: grid;
      grid-template-columns: minmax(280px, 340px) 1fr;
      gap: 26px;
      position: relative;
      z-index: 1;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 25px 65px rgba(6, 10, 25, 0.55);
      backdrop-filter: blur(14px);
    }
    label {
      display: block;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 8px;
    }
    input,
    select {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(62, 86, 146, 0.7);
      background: linear-gradient(135deg, rgba(9, 17, 40, 0.95), rgba(12, 24, 50, 0.95));
      color: #f5f9ff;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    input:focus,
    select:focus {
      border-color: rgba(110, 231, 255, 0.6);
      box-shadow: 0 0 0 2px rgba(110, 231, 255, 0.22);
    }
    input::placeholder {
      color: rgba(142, 163, 199, 0.8);
    }
    select option {
      background-color: #0b1326;
      color: #f5f9ff;
    }
    select option[value=""] {
      color: rgba(142, 163, 199, 0.9);
    }
    select option:checked,
    select option:hover {
      background-color: #162450;
      color: #6ee7ff;
    }
    button {
      width: 100%;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid transparent;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      background: linear-gradient(135deg, rgba(110, 231, 255, 0.35), rgba(79, 157, 255, 0.55));
      color: #021020;
      transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease, background 0.18s ease;
      box-shadow: 0 14px 38px rgba(9, 123, 255, 0.32);
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 46px rgba(9, 123, 255, 0.38);
    }
    button:active {
      transform: translateY(0);
    }
    button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
    }
    button.ghost {
      background: rgba(14, 22, 46, 0.85);
      color: #f2f6ff;
      border-color: rgba(62, 86, 146, 0.7);
      box-shadow: none;
    }
    button.ghost:hover {
      border-color: var(--accent);
      background: rgba(17, 28, 56, 0.92);
    }
    button.danger {
      color: #fda4af;
      border-color: rgba(248, 113, 113, 0.4);
    }
    button.danger:hover {
      border-color: rgba(248, 113, 113, 0.85);
      color: #fecaca;
    }
    .row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
      align-items: end;
    }
    .row.row--inputs {
      align-items: start;
    }
    .hint {
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.5;
    }
    .flex {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .types {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .type {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      text-transform: capitalize;
      background: color-mix(in srgb, var(--type-color, rgba(255, 255, 255, 0.2)) 40%, transparent);
      border: 1px solid color-mix(in srgb, var(--type-color, rgba(94, 106, 144, 0.9)) 55%, transparent);
      color: color-mix(in srgb, var(--type-color, #9ec7ff) 70%, #f2f6ff 30%);
    }
    .type::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--type-color, var(--accent));
    }
    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(62, 86, 146, 0.8);
      font-size: 12px;
      color: var(--muted);
      background: rgba(14, 22, 46, 0.85);
    }
    .result {
      display: grid;
      grid-template-columns: 130px 1fr;
      gap: 20px;
      align-items: start;
    }
    .sprite {
      width: 118px;
      height: 118px;
      border-radius: 16px;
      background: rgba(5, 10, 25, 0.7);
      border: 1px solid rgba(47, 68, 118, 0.85);
      display: grid;
      place-items: center;
      image-rendering: pixelated;
    }
    .sprite img {
      filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.4));
    }
    .grid {
      display: grid;
      gap: 12px;
    }
    .grid.two {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    .stat {
      background: rgba(8, 16, 36, 0.8);
      border: 1px solid rgba(40, 60, 108, 0.8);
      border-radius: 14px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .stat b {
      font-size: 18px;
      font-weight: 700;
    }
    .weak { color: var(--bad); }
    .res { color: var(--good); }
    .moves-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
      line-height: 1.4;
    }
    .moves-list button {
      width: 100%;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(36, 55, 108, 0.8);
      background: rgba(9, 16, 36, 0.9);
      color: #f2f6ff;
      font: inherit;
      text-align: left;
      cursor: pointer;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      box-shadow: none;
    }
    .moves-list button.recommended::before {
      content: "★";
      color: var(--accent);
      margin-right: 6px;
      font-size: 12px;
    }
    .moves-list button.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(110, 231, 255, 0.4);
      background: rgba(110, 231, 255, 0.12);
    }
    .moves-list button:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    .moves-list button .label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: block;
    }
    .moves-list.mini { gap: 4px; }
    .moves-list.mini button {
      font-size: 11px;
      padding: 4px 6px;
    }
    #featuredMoves {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .featured-row {
      border: 1px solid rgba(40, 60, 108, 0.8);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(8, 16, 36, 0.9);
      font-size: 12px;
      color: var(--muted);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .featured-row.active {
      border-color: rgba(110, 231, 255, 0.6);
      color: #f2f6ff;
      box-shadow: 0 0 0 1px rgba(110, 231, 255, 0.28);
    }
    .featured-row .label {
      display: block;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .featured-row.active .label { color: var(--accent); }
    .statline {
      margin-top: 6px;
      font-size: 13px;
      color: var(--muted);
    }
    .team {
      display: grid;
      gap: 12px;
      margin-top: 8px;
    }
    .slot {
      background: rgba(8, 16, 36, 0.72);
      border: 1px dashed rgba(47, 68, 118, 0.6);
      border-radius: 12px;
      padding: 16px;
      min-height: 82px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: rgba(142, 163, 199, 0.7);
    }
    .slot.filled {
      display: block;
      border-style: solid;
      border-color: rgba(40, 60, 108, 0.85);
      background: rgba(10, 18, 38, 0.92);
      padding: 12px;
      color: inherit;
    }
    .team-entry {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      width: 100%;
    }
    .team-entry__content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .team-thumb {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      border: 1px solid rgba(47, 68, 118, 0.75);
      background: rgba(7, 12, 26, 0.95);
      object-fit: contain;
      image-rendering: pixelated;
    }
    .team-entry .team-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 120px;
    }
    .team-entry .team-actions button { width: 100%; }
    .team-moves {
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .team-moves .label {
      font-weight: 600;
      color: #f2f6ff;
      margin-right: 4px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-size: 11px;
      display: inline-block;
    }
    .team-moves.small { font-size: 11px; text-align: right; }
    .team-moves.small .label { font-size: 10px; }
    .team-summary-trigger {
      margin-top: 12px;
      display: flex;
    }
    .team-summary-trigger button {
      width: auto;
      margin-left: auto;
    }
    .rankings {
      display: grid;
      gap: 12px;
      margin-top: 12px;
    }
    .rank-item {
      background: rgba(8, 16, 36, 0.85);
      border: 1px solid rgba(40, 60, 108, 0.85);
      border-radius: 16px;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
    }
    .rank-item .l {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .rank-item .r {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
    }
    .rank-item .r .top {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 12px rgba(110, 231, 255, 0.65);
    }
    .score {
      font-variant-numeric: tabular-nums;
      font-weight: 700;
    }
    .hidden { display: none !important; }
    .voice-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
    }
    #voiceBtn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .mic {
      width: 12px;
      height: 24px;
      border-radius: 12px;
      border: 2px solid #021020;
      background: rgba(2, 16, 32, 0.9);
      position: relative;
      box-shadow: inset 0 0 12px rgba(255, 255, 255, 0.1);
    }
    .mic::after {
      content: "";
      position: absolute;
      bottom: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 16px;
      height: 3px;
      border-radius: 3px;
      background: rgba(2, 16, 32, 0.8);
    }
    footer {
      max-width: 1200px;
      margin: 0 auto 60px;
      padding: 0 22px;
      color: var(--muted);
      position: relative;
      z-index: 1;
    }
    footer p { line-height: 1.6; }
    a { color: var(--accent); }
    .kbd {
      font-family: ui-monospace, "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: rgba(8, 16, 36, 0.9);
      border: 1px solid rgba(36, 55, 108, 0.8);
      padding: 2px 6px;
      border-radius: 6px;
      color: #f2f6ff;
    }
    /* Team summary overlay */
    .team-summary {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 16, 0.72);
      backdrop-filter: blur(18px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 18px;
      transition: opacity 0.2s ease;
      opacity: 0;
      pointer-events: none;
      z-index: 20;
    }
    .team-summary.visible {
      opacity: 1;
      pointer-events: auto;
    }
    .team-summary__card {
      width: min(920px, 100%);
      max-height: 80vh;
      overflow-y: auto;
      background: rgba(16, 24, 48, 0.96);
      border: 1px solid rgba(86, 112, 180, 0.55);
      border-radius: 22px;
      padding: 22px;
      box-shadow: 0 24px 70px rgba(5, 10, 30, 0.65);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .team-summary__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .team-summary__header h2 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.03em;
    }
    .team-summary__content {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .team-summary-intro {
      font-size: 14px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .team-summary-team {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .team-summary-team-member {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(8, 16, 36, 0.85);
      border: 1px solid rgba(40, 60, 108, 0.7);
      font-size: 13px;
    }
    .team-summary-team-member img {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      border: 1px solid rgba(47, 68, 118, 0.8);
      background: rgba(7, 12, 26, 0.9);
      image-rendering: pixelated;
    }
    .team-summary-warning {
      font-size: 13px;
      color: #facc15;
      background: rgba(59, 37, 10, 0.32);
      border: 1px solid rgba(250, 204, 21, 0.4);
      border-radius: 12px;
      padding: 10px 12px;
    }
    .team-coverage h3,
    .team-breakdown h3 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.02em;
    }
    .team-coverage-grid {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }
    .coverage-card {
      background: rgba(8, 16, 36, 0.9);
      border: 1px solid rgba(40, 60, 108, 0.75);
      border-radius: 14px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: transform 0.2s ease, border-color 0.2s ease;
    }
    .coverage-card:hover {
      transform: translateY(-2px);
      border-color: rgba(110, 231, 255, 0.5);
    }
    .coverage-card.muted { opacity: 0.4; }
    .coverage-counts {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .coverage-count {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(40, 60, 108, 0.6);
      background: rgba(12, 20, 42, 0.85);
      color: var(--muted);
    }
    .coverage-count:not(.has-value) {
      opacity: 0.5;
    }
    .coverage-count strong {
      font-variant-numeric: tabular-nums;
      color: #f2f6ff;
    }
    .coverage-count.weak {
      border-color: rgba(248, 113, 113, 0.45);
      background: rgba(127, 29, 29, 0.35);
      color: var(--bad);
    }
    .coverage-count.resist {
      border-color: rgba(74, 222, 128, 0.4);
      background: rgba(20, 83, 45, 0.35);
      color: var(--good);
    }
    .coverage-count.immune {
      border-color: rgba(253, 224, 71, 0.4);
      background: rgba(113, 63, 18, 0.35);
      color: #fde68a;
    }
    .team-breakdown-grid {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 14px;
    }
    .team-breakdown-card {
      background: rgba(8, 16, 36, 0.92);
      border: 1px solid rgba(40, 60, 108, 0.8);
      border-radius: 16px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .team-breakdown-card .card-head {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .summary-thumb {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid rgba(47, 68, 118, 0.8);
      background: rgba(7, 12, 26, 0.9);
      image-rendering: pixelated;
    }
    .team-breakdown-card .card-title {
      font-weight: 600;
      font-size: 16px;
      letter-spacing: 0.03em;
    }
    .team-breakdown-card .card-body {
      display: grid;
      gap: 10px;
    }
    .team-breakdown-card .label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
    }
    .type-chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .type-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      text-transform: capitalize;
      border: 1px solid color-mix(in srgb, var(--type-color, rgba(62, 86, 146, 0.8)) 60%, transparent);
      background: color-mix(in srgb, var(--type-color, rgba(12, 20, 42, 0.9)) 45%, rgba(12, 20, 42, 0.9) 55%);
      color: color-mix(in srgb, var(--type-color, #dceaff) 60%, #f2f6ff 40%);
    }
    .type-chip .type-mult {
      font-variant-numeric: tabular-nums;
      font-size: 11px;
      opacity: 0.75;
      color: inherit;
    }
    .type-chip.weak {
      background: rgba(127, 29, 29, 0.4);
      border-color: rgba(248, 113, 113, 0.5);
      color: #fecaca;
    }
    .type-chip.resist {
      background: rgba(20, 83, 45, 0.4);
      border-color: rgba(74, 222, 128, 0.5);
      color: #bbf7d0;
    }
    .type-chip.immune {
      background: rgba(113, 63, 18, 0.4);
      border-color: rgba(250, 204, 21, 0.45);
      color: #fde68a;
    }
    .type-chip.muted {
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(36, 55, 108, 0.7);
      color: var(--muted);
    }
    @media (max-width: 1020px) {
      main { grid-template-columns: 1fr; }
      header h1::after { display: none; }
      .result { grid-template-columns: 1fr; }
    }
    @media (max-width: 600px) {
      main { padding: 24px 16px 40px; }
      header { padding: 20px 18px 8px; }
      header h1 { font-size: 20px; }
      .row { grid-template-columns: 1fr; }
      .team-summary__card { padding: 18px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>🎙️ Voice Pokédex (offline) — weaknesses, resistances & team ranking</h1>
  </header>

  <main>
    <section class="card" aria-label="Controls">
      <div class="row row--inputs" role="group" aria-label="Search">
        <div>
          <label for="nameInput">Pokémon name</label>
          <input id="nameInput" placeholder="e.g. Charizard" autocomplete="off" />
        </div>
        <div>
          <label for="nameSelect">Quick select</label>
          <select id="nameSelect" aria-label="Quick select Pokémon"></select>
        </div>
      </div>
      <div class="hint">Type a name, pick from the list, or use voice.</div>

      <div class="row" style="margin-top:10px;">
        <button id="voiceBtn" class="voice-btn" aria-label="Hold to speak">
          <span class="mic" aria-hidden="true"></span>
          <span id="voiceLabel">Hold to speak</span>
        </button>
        <button id="randomBtn" type="button" aria-label="Pick a random Pokémon">Random Pokémon</button>
      </div>

      <div class="hint" id="voiceHint">
        Voice tips: Press and hold the mic, say the name (e.g., <span class="kbd">pikachu</span>), release. Works best in Chrome / Edge.
      </div>

      <div style="margin-top:16px;">
        <label for="leagueSelect">League defaults</label>
        <select id="leagueSelect" aria-label="Select PvP league"></select>
      </div>

      <hr style="border-color:#1e294f; margin:14px 0; opacity:.5;"/>

      <div>
        <label>My team (pick up to 3)</label>
        <div class="team" id="teamSlots" aria-live="polite"></div>
        <div class="row" style="margin-top:10px;">
          <select id="teamSelect" aria-label="Add Pokémon to team"></select>
          <button id="addToTeamBtn">Add to team</button>
        </div>
        <div class="hint">Team is saved locally in your browser (no internet needed).</div>
        <div class="team-summary-trigger">
          <button id="teamSummaryBtn" class="ghost" type="button" aria-expanded="false" aria-controls="teamSummaryPanel">Team type summary</button>
        </div>
      </div>
    </section>

    <section class="card" aria-label="Results">
      <div id="result" class="hidden">
        <div class="result">
          <div>
            <div class="sprite">
              <img id="sprite" alt="sprite" width="96" height="96" />
            </div>
          </div>
          <div>
            <h2 id="title" style="margin:0 0 6px 0"></h2>
            <div class="types" id="types"></div>
            <div style="margin-top:10px;" class="grid">
              <div class="stat"><div>Weak to</div><b class="weak" id="weakTo">–</b></div>
              <div class="stat"><div>Resists</div><b class="res" id="resists">–</b></div>
              <div class="stat"><div>Immune to</div><b id="immune">–</b></div>
            </div>
            <div style="margin-top:10px;" class="grid two info-grid">
              <div class="stat"><div>GO Stats</div><div id="goStats" class="statline">–</div></div>
              <div class="stat"><div>Fast attacks</div><div class="moves-list" id="fastMoves">–</div></div>
              <div class="stat"><div>Charged attacks</div><div class="moves-list" id="chargedMoves">–</div></div>
              <div class="stat"><div>Featured moves (PvPoke)</div><div id="featuredMoves">–</div></div>
            </div>
          </div>
        </div>
        <h3 style="margin:16px 0 6px 0">My Team vs <span id="vsName"></span></h3>
        <div id="rankings" class="rankings"></div>
      </div>
      <div id="emptyState" class="hint">Choose a Pokémon to see its matchups.</div>
    </section>
  </main>

  <div id="teamSummaryPanel" class="team-summary hidden" role="dialog" aria-modal="true" aria-labelledby="teamSummaryTitle" aria-hidden="true">
    <div class="team-summary__card" tabindex="-1">
      <div class="team-summary__header">
        <h2 id="teamSummaryTitle">Team type coverage</h2>
        <button type="button" id="closeTeamSummary" class="ghost">Close</button>
      </div>
      <div id="teamSummaryContent" class="team-summary__content"></div>
    </div>
  </div>

  <footer>
    <p><b>Offline data:</b> This page looks for <span class="kbd">data/pokemon.min.json</span> and local sprites in <span class="kbd">sprites/</span> (e.g. <span class="kbd">sprites/006.png</span>). If not found, it falls back to a tiny built-in sample so you can test instantly. Replace the JSON with a full dataset for all Pokémon.</p>
    <p class="hint">Voice search works in the browser build (Chrome/Edge). The desktop app runs fully offline but does not include voice input.</p>
  </footer>

  <script src="data/mega-origin-sprites.js"></script>
  <script>
  // ------------------ Type Chart (attack -> defense multiplier) ------------------
  const TYPES = [
    'normal','fire','water','electric','grass','ice','fighting','poison','ground','flying','psychic','bug','rock','ghost','dragon','dark','steel','fairy'
  ];
  const TYPE_CHART = {
    normal:   { rock:.5, ghost:0, steel:.5 },
    fire:     { fire:.5, water:.5, grass:2, ice:2, bug:2, rock:.5, dragon:.5, steel:2 },
    water:    { fire:2, water:.5, grass:.5, ground:2, rock:2, dragon:.5 },
    electric: { water:2, electric:.5, grass:.5, ground:0, flying:2, dragon:.5 },
    grass:    { fire:.5, water:2, grass:.5, poison:.5, ground:2, flying:.5, bug:.5, rock:2, dragon:.5, steel:.5 },
    ice:      { fire:.5, water:.5, grass:2, ground:2, flying:2, dragon:2, steel:.5 },
    fighting: { normal:2, ice:2, rock:2, dark:2, steel:2, poison:.5, flying:.5, psychic:.5, bug:.5, fairy:.5, ghost:0 },
    poison:   { grass:2, poison:.5, ground:.5, rock:.5, ghost:.5, steel:0, fairy:2 },
    ground:   { fire:2, electric:2, grass:.5, poison:2, flying:0, bug:.5, rock:2, steel:2 },
    flying:   { electric:.5, grass:2, fighting:2, bug:2, rock:.5, steel:.5 },
    psychic:  { fighting:2, poison:2, psychic:.5, dark:0, steel:.5 },
    bug:      { fire:.5, grass:2, fighting:.5, poison:.5, flying:.5, psychic:2, ghost:.5, dark:2, steel:.5, fairy:.5 },
    rock:     { fire:2, ice:2, fighting:.5, ground:.5, flying:2, bug:2, steel:.5 },
    ghost:    { normal:0, psychic:2, dark:.5 },
    dragon:   { dragon:2, steel:.5, fairy:0 },
    dark:     { fighting:.5, psychic:2, ghost:2, dark:.5, fairy:.5 },
    steel:    { fire:.5, water:.5, electric:.5, ice:2, rock:2, fairy:2, steel:.5 },
    fairy:    { fire:.5, fighting:2, poison:.5, dragon:2, dark:2, steel:.5 }
  };
  const TYPE_COLORS = {
    normal: '#a8a77a',
    fire: '#ee8130',
    water: '#6390f0',
    electric: '#f7d02c',
    grass: '#7ac74c',
    ice: '#96d9d6',
    fighting: '#c22e28',
    poison: '#a33ea1',
    ground: '#e2bf65',
    flying: '#a98ff3',
    psychic: '#f95587',
    bug: '#a6b91a',
    rock: '#b6a136',
    ghost: '#735797',
    dragon: '#6f35fc',
    dark: '#705746',
    steel: '#b7b7ce',
    fairy: '#d685ad',
  };

  function effectiveness(attackType, defendTypes){
    let mult = 1;
    const rules = TYPE_CHART[attackType] || {};
    for (const dt of defendTypes){
      const m = rules[dt];
      if (m === 0) return 0; // immunity dominates
      if (m) mult *= m;
    }
    return mult;
  }
  function defendMultipliers(defendTypes){
    const out = {};
    for (const atk of TYPES) out[atk] = effectiveness(atk, defendTypes);
    return out;
  }

  function buildSampleMove(id, name, type, category, power, energy, cooldown){
    const move = { id, name, type, category, power, energy };
    if (typeof cooldown === 'number' && cooldown > 0){
      move.cooldown = Number(cooldown.toFixed(2));
      move.turns = Number((cooldown / 0.5).toFixed(2));
      if (typeof power === 'number'){
        move.dps = Number((power / cooldown).toFixed(2));
      }
      if (typeof energy === 'number'){
        move.eps = Number((energy / cooldown).toFixed(2));
      }
    }
    if (category === 'charged' && typeof power === 'number' && typeof energy === 'number' && energy !== 0){
      move.dpe = Number((power / Math.abs(energy)).toFixed(2));
    }
    return move;
  }

  // ------------------ Minimal Sample Data (fallback) ------------------
  const SAMPLE_DATA = [
    {
      dex:1,
      name:"Bulbasaur",
      slug:"bulbasaur",
      types:["grass","poison"],
      released:true,
      stats:{attack:118,defense:111,stamina:128},
      moves:{
        fast:[
          buildSampleMove('VINE_WHIP','Vine Whip (Fast)','grass','fast',5,8,0.6),
          buildSampleMove('TACKLE','Tackle (Fast)','normal','fast',4,5,0.5)
        ],
        charged:[
          buildSampleMove('POWER_WHIP','Power Whip','grass','charged',90,-50),
          buildSampleMove('SEED_BOMB','Seed Bomb','grass','charged',60,-45),
          buildSampleMove('SLUDGE_BOMB','Sludge Bomb','poison','charged',80,-50)
        ],
        recommended:{fast:'VINE_WHIP',charged:['POWER_WHIP','SLUDGE_BOMB']}
      }
    },
    {
      dex:4,
      name:"Charmander",
      slug:"charmander",
      types:["fire"],
      released:true,
      stats:{attack:116,defense:93,stamina:118},
      moves:{
        fast:[
          buildSampleMove('EMBER','Ember (Fast)','fire','fast',6,6,1.0),
          buildSampleMove('SCRATCH','Scratch (Fast)','normal','fast',4,2,0.5)
        ],
        charged:[
          buildSampleMove('FLAME_BURST','Flame Burst','fire','charged',70,-50),
          buildSampleMove('FLAME_CHARGE','Flame Charge','fire','charged',70,-45),
          buildSampleMove('FLAMETHROWER','Flamethrower','fire','charged',90,-55)
        ],
        recommended:{fast:'EMBER',charged:['FLAME_CHARGE','FLAMETHROWER']}
      }
    },
    {
      dex:6,
      name:"Charizard",
      slug:"charizard",
      types:["fire","flying"],
      stats:{attack:223,defense:173,stamina:186},
      moves:{
        fast:[
          buildSampleMove('AIR_SLASH','Air Slash (Fast)','flying','fast',9,9,1.2),
          buildSampleMove('FIRE_SPIN','Fire Spin (Fast)','fire','fast',9,10,1.1)
        ],
        charged:[
          buildSampleMove('BLAST_BURN','Blast Burn','fire','charged',110,-50),
          buildSampleMove('DRAGON_CLAW','Dragon Claw','dragon','charged',50,-35),
          buildSampleMove('OVERHEAT','Overheat','fire','charged',160,-65)
        ],
        recommended:{fast:'FIRE_SPIN',charged:['BLAST_BURN','DRAGON_CLAW']}
      }
    },
    {
      dex:7,
      name:"Squirtle",
      slug:"squirtle",
      types:["water"],
      stats:{attack:94,defense:121,stamina:127},
      moves:{
        fast:[
          buildSampleMove('BUBBLE','Bubble (Fast)','water','fast',7,11,1.2),
          buildSampleMove('TACKLE','Tackle (Fast)','normal','fast',4,5,0.5)
        ],
        charged:[
          buildSampleMove('AQUA_JET','Aqua Jet','water','charged',45,-45),
          buildSampleMove('AQUA_TAIL','Aqua Tail','water','charged',50,-35),
          buildSampleMove('WATER_PULSE','Water Pulse','water','charged',70,-60)
        ],
        recommended:{fast:'BUBBLE',charged:['AQUA_TAIL','AQUA_JET']}
      }
    },
    {
      dex:25,
      name:"Pikachu",
      slug:"pikachu",
      types:["electric"],
      stats:{attack:112,defense:96,stamina:111},
      moves:{
        fast:[
          buildSampleMove('QUICK_ATTACK','Quick Attack (Fast)','normal','fast',5,8,0.8),
          buildSampleMove('THUNDER_SHOCK','Thunder Shock (Fast)','electric','fast',3,9,0.6)
        ],
        charged:[
          buildSampleMove('DISCHARGE','Discharge','electric','charged',65,-45),
          buildSampleMove('THUNDER','Thunder','electric','charged',100,-60),
          buildSampleMove('WILD_CHARGE','Wild Charge','electric','charged',100,-45)
        ],
        recommended:{fast:'THUNDER_SHOCK',charged:['WILD_CHARGE','THUNDER']}
      }
    },
    {
      dex:94,
      name:"Gengar",
      slug:"gengar",
      types:["ghost","poison"],
      stats:{attack:261,defense:149,stamina:155},
      moves:{
        fast:[
          buildSampleMove('HEX','Hex (Fast)','ghost','fast',8,12,1.0),
          buildSampleMove('SUCKER_PUNCH','Sucker Punch (Fast)','dark','fast',7,8,1.5)
        ],
        charged:[
          buildSampleMove('SHADOW_BALL','Shadow Ball','ghost','charged',100,-55),
          buildSampleMove('SHADOW_PUNCH','Shadow Punch','ghost','charged',55,-35),
          buildSampleMove('SLUDGE_BOMB','Sludge Bomb','poison','charged',80,-50)
        ],
        recommended:{fast:'HEX',charged:['SHADOW_BALL','SHADOW_PUNCH']}
      }
    },
    {
      dex:149,
      name:"Dragonite",
      slug:"dragonite",
      types:["dragon","flying"],
      stats:{attack:263,defense:198,stamina:209},
      moves:{
        fast:[
          buildSampleMove('DRAGON_BREATH','Dragon Breath (Fast)','dragon','fast',4,3,0.5),
          buildSampleMove('STEEL_WING','Steel Wing (Fast)','steel','fast',11,6,1.4)
        ],
        charged:[
          buildSampleMove('DRAGON_CLAW','Dragon Claw','dragon','charged',50,-35),
          buildSampleMove('DRAGON_PULSE','Dragon Pulse','dragon','charged',90,-60),
          buildSampleMove('HURRICANE','Hurricane','flying','charged',110,-65)
        ],
        recommended:{fast:'DRAGON_BREATH',charged:['DRAGON_CLAW','HURRICANE']}
      }
    },
    {
      dex:131,
      name:"Lapras",
      slug:"lapras",
      types:["water","ice"],
      stats:{attack:165,defense:174,stamina:277},
      moves:{
        fast:[
          buildSampleMove('FROST_BREATH','Frost Breath (Fast)','ice','fast',10,8,1.1),
          buildSampleMove('WATER_GUN','Water Gun (Fast)','water','fast',5,5,0.5)
        ],
        charged:[
          buildSampleMove('BLIZZARD','Blizzard','ice','charged',130,-75),
          buildSampleMove('ICE_BEAM','Ice Beam','ice','charged',90,-55),
          buildSampleMove('SURF','Surf','water','charged',65,-40)
        ],
        recommended:{fast:'WATER_GUN',charged:['SURF','ICE_BEAM']}
      }
    },
    {
      dex:143,
      name:"Snorlax",
      slug:"snorlax",
      types:["normal"],
      stats:{attack:190,defense:169,stamina:330},
      moves:{
        fast:[
          buildSampleMove('LICK','Lick (Fast)','ghost','fast',4,3,0.5),
          buildSampleMove('ZEN_HEADBUTT','Zen Headbutt (Fast)','psychic','fast',11,9,1.1)
        ],
        charged:[
          buildSampleMove('BODY_SLAM','Body Slam','normal','charged',60,-35),
          buildSampleMove('EARTHQUAKE','Earthquake','ground','charged',120,-65),
          buildSampleMove('HYPER_BEAM','Hyper Beam','normal','charged',150,-80)
        ],
        recommended:{fast:'LICK',charged:['BODY_SLAM','EARTHQUAKE']}
      }
    },
    {
      dex:212,
      name:"Scizor",
      slug:"scizor",
      types:["bug","steel"],
      stats:{attack:236,defense:181,stamina:172},
      moves:{
        fast:[
          buildSampleMove('BULLET_PUNCH','Bullet Punch (Fast)','steel','fast',9,7,1.0),
          buildSampleMove('FURY_CUTTER','Fury Cutter (Fast)','bug','fast',3,6,0.4)
        ],
        charged:[
          buildSampleMove('IRON_HEAD','Iron Head','steel','charged',70,-50),
          buildSampleMove('NIGHT_SLASH','Night Slash','dark','charged',50,-35),
          buildSampleMove('X_SCISSOR','X-Scissor','bug','charged',45,-35)
        ],
        recommended:{fast:'BULLET_PUNCH',charged:['NIGHT_SLASH','IRON_HEAD']}
      }
    }
  ];

  const LEAGUES = [
    { key: 'great', label: 'Great League (1500 CP)', short: 'Great' },
    { key: 'ultra', label: 'Ultra League (2500 CP)', short: 'Ultra' },
    { key: 'master', label: 'Master League (10000 CP)', short: 'Master' },
    { key: 'little', label: 'Little League (500 CP)', short: 'Little' },
  ];
  const LEAGUE_PRIORITY = LEAGUES.map(l => l.key);
  const ACTIVE_MOVES_STORAGE_KEY = 'activeMovesV1';
  const LEAGUE_STORAGE_KEY = 'preferredLeague';

  let POKEMON = [];
  let RELEASED_POKEMON = [];
  let POKEMON_BY_SLUG = new Map();
  let currentPokemon = null;
  let currentLeague = 'great';
  let activeMovesState = {};

  function leagueInfo(key){
    return LEAGUES.find(l => l.key === key) || null;
  }
  function leagueLabel(key){
    const info = leagueInfo(key);
    return info ? info.label : key;
  }
  function leagueShort(key){
    const info = leagueInfo(key);
    return info ? info.short : key;
  }
  function loadStoredLeague(){
    try {
      const stored = localStorage.getItem(LEAGUE_STORAGE_KEY);
      if (stored && LEAGUE_PRIORITY.includes(stored)) return stored;
    } catch {}
    return LEAGUE_PRIORITY[0];
  }
  function loadActiveMoves(){
    try {
      const raw = localStorage.getItem(ACTIVE_MOVES_STORAGE_KEY);
      if (!raw) return {};
      const parsed = JSON.parse(raw);
      return parsed && typeof parsed === 'object' ? parsed : {};
    } catch {
      return {};
    }
  }
  function saveActiveMoves(){
    try { localStorage.setItem(ACTIVE_MOVES_STORAGE_KEY, JSON.stringify(activeMovesState)); } catch {}
  }
  function dedupePokemon(list){
    const seen = new Set();
    const out = [];
    for (const entry of list || []){
      if (!entry) continue;
      const slug = (entry.slug || '').toLowerCase();
      const key = slug || `${entry.dex || 0}:${(entry.name || '').toLowerCase()}`;
      if (seen.has(key)) continue;
      seen.add(key);
      out.push(entry);
    }
    return out;
  }
  function rebuildPokemonIndex(){
    POKEMON_BY_SLUG = new Map();
    for (const entry of POKEMON){
      if (!entry) continue;
      if (entry.slug) POKEMON_BY_SLUG.set(entry.slug, entry);
      if (entry.name) POKEMON_BY_SLUG.set(entry.name.toLowerCase(), entry);
    }
  }
  function applyDataset(list){
    const deduped = dedupePokemon(list || []);
    if (list && list.length && deduped.length !== list.length){
      console.log(`Removed ${list.length - deduped.length} duplicate entries from dataset.`);
    }
    POKEMON = deduped;
    RELEASED_POKEMON = deduped.filter(entry => entry && entry.released !== false);
    rebuildPokemonIndex();
    if (currentPokemon){
      const updated = getPokemonBySlug(currentPokemon.slug) || byName(currentPokemon.name);
      if (updated && updated.released !== false) currentPokemon = updated;
      else currentPokemon = null;
    }
  }

  activeMovesState = loadActiveMoves();
  currentLeague = loadStoredLeague();
  applyDataset(SAMPLE_DATA);

  async function tryLoadExternalData(){
    try {
      const res = await fetch('data/pokemon.min.json');
      if (!res.ok) return;
      const json = await res.json();
      if (Array.isArray(json) && json.length) {
        applyDataset(json);
        console.log(`Loaded external dataset with ${json.length} Pokémon.`);
      }
    } catch(e){ console.warn('Using built-in sample data.', e); }
  }

  // ------------------ UI Refs ------------------
  const nameInput  = document.getElementById('nameInput');
  const nameSelect = document.getElementById('nameSelect');
  const teamSelect = document.getElementById('teamSelect');
  const addToTeamBtn = document.getElementById('addToTeamBtn');
  const teamSlots = document.getElementById('teamSlots');
  const voiceBtn = document.getElementById('voiceBtn');
  const voiceLabel = document.getElementById('voiceLabel');
  const voiceHintEl = document.getElementById('voiceHint');
  const randomBtn = document.getElementById('randomBtn');
  const resultEl = document.getElementById('result');
  const emptyState = document.getElementById('emptyState');
  const DEFAULT_EMPTY_TEXT = emptyState ? emptyState.textContent : '';
  const titleEl = document.getElementById('title');
  const typesEl = document.getElementById('types');
  const weakEl = document.getElementById('weakTo');
  const resEl = document.getElementById('resists');
  const immEl = document.getElementById('immune');
  const fastMovesEl = document.getElementById('fastMoves');
  const chargedMovesEl = document.getElementById('chargedMoves');
  const statsEl = document.getElementById('goStats');
  const spriteEl = document.getElementById('sprite');
  const vsName = document.getElementById('vsName');
  const rankingsEl = document.getElementById('rankings');
  const leagueSelect = document.getElementById('leagueSelect');
  const featuredMovesEl = document.getElementById('featuredMoves');
  const teamSummaryBtn = document.getElementById('teamSummaryBtn');
  const teamSummaryPanel = document.getElementById('teamSummaryPanel');
  const teamSummaryContent = document.getElementById('teamSummaryContent');
  const closeTeamSummaryBtn = document.getElementById('closeTeamSummary');

  // ------------------ Helpers ------------------
  function byName(name){
    name = (name || '').toString().trim().toLowerCase();
    if (!name) return null;
    const pool = RELEASED_POKEMON.length ? RELEASED_POKEMON : POKEMON;
    let p = pool.find(x => x.name.toLowerCase() === name);
    if (p) return p;
    p = pool.find(x => x.name.toLowerCase().startsWith(name)) || pool.find(x => x.name.toLowerCase().includes(name));
    return p || null;
  }
  function typeLabel(type){
    const text = (type || '').toString().replace(/-/g, ' ');
    return text.replace(/\b\w/g, c => c.toUpperCase());
  }
  function typeColor(type){
    return TYPE_COLORS[type] || '#6f7bff';
  }
  function formatTypes(types){
    return (types || []).map(t => {
      const label = typeLabel(t);
      const color = typeColor(t);
      return `<span class="type" data-type="${t}" style="--type-color:${color}">${label}</span>`;
    }).join('');
  }
  function formatMultiplierValue(mult){
    if (mult === 0) return '0';
    const rounded = Math.abs(mult - Math.round(mult)) < 1e-2 ? Math.round(mult) : Number(mult.toFixed(2));
    return String(rounded);
  }
  function breakdownMultipliers(m){
    const entries = Object.entries(m || {});
    const mapEntry = (type, mult) => ({
      type,
      label: typeLabel(type),
      mult,
      multiplierText: `×${formatMultiplierValue(mult)}`,
    });
    return {
      weak: entries.filter(([,v])=>v>1).sort((a,b)=>b[1]-a[1]).map(([type, mult])=>mapEntry(type, mult)),
      res: entries.filter(([,v])=>v>0 && v<1).sort((a,b)=>a[1]-b[1]).map(([type, mult])=>mapEntry(type, mult)),
      imm: entries.filter(([,v])=>v===0).map(([type])=>({ type, label: typeLabel(type), mult:0, multiplierText:'×0' })),
    };
  }
  function listFromMults(m){
    const breakdown = breakdownMultipliers(m);
    return {
      weak: breakdown.weak.map(entry => `${entry.label} ${entry.multiplierText}`),
      res: breakdown.res.map(entry => `${entry.label} ${entry.multiplierText}`),
      imm: breakdown.imm.map(entry => entry.label),
    };
  }
  function renderTypeChipList(list, variant){
    if (!Array.isArray(list) || !list.length){
      return '<span class="type-chip muted">None</span>';
    }
    return list.map(entry => {
      const color = typeColor(entry.type);
      const mult = entry.multiplierText && variant !== 'immune'
        ? `<span class="type-mult">${entry.multiplierText}</span>`
        : (variant === 'immune' ? `<span class="type-mult">${entry.multiplierText || '×0'}</span>` : '');
      return `<span class="type-chip ${variant}" style="--type-color:${color}"><span>${entry.label}</span>${mult}</span>`;
    }).join('');
  }
  function normalizeMove(move){
    if (!move) return null;
    if (typeof move === 'string'){ return { id: move, name: move, category: 'unknown' }; }
    const copy = {...move};
    if (copy.id) copy.id = String(copy.id);
    if (copy.name) copy.name = String(copy.name);
    if (copy.type) copy.type = String(copy.type).toLowerCase();
    if (!copy.id && copy.name){ copy.id = copy.name.toUpperCase().replace(/[^A-Z0-9]+/g,'_'); }
    return copy;
  }
  function getMoveCache(p){
    if (!p) return {fast:[], charged:[]};
    if (!p._moveCache){
      const fast = (p.moves?.fast || []).map(normalizeMove).filter(Boolean);
      const charged = (p.moves?.charged || []).map(normalizeMove).filter(Boolean);
      p._moveCache = {fast, charged};
    }
    return p._moveCache;
  }
  function describeMove(move){
    if (!move) return '–';
    const name = typeof move === 'string' ? move : (move.name || move.id || 'Unknown move');
    const type = typeof move === 'object' && move?.type ? move.type : '';
    return type ? `${name} · ${type}` : name;
  }
  function findMove(moves, key){
    if (!key) return null;
    const raw = String(key);
    const upper = raw.toUpperCase();
    for (const m of moves){
      if (m.id && (m.id === raw || m.id === upper)) return m;
    }
    const lower = raw.toLowerCase();
    return moves.find(m => (m.name && m.name.toLowerCase() === lower)) || null;
  }
  function activeMovesKey(p, league){
    const slug = (p?.slug || p?.name || '').toString().toLowerCase();
    return `${league || 'any'}::${slug}`;
  }
  function getPokemonBySlug(slug){
    if (!slug) return null;
    return POKEMON_BY_SLUG.get(slug) || POKEMON_BY_SLUG.get(slug.toLowerCase()) || null;
  }
  function getRecommendedInfo(p, league = currentLeague){
    const pool = getMoveCache(p);
    const rec = p.moves?.recommended || {};
    const perLeagueRaw = rec.perLeague || rec.leagues || {};
    const resolvedPerLeague = {};
    for (const [key, moves] of Object.entries(perLeagueRaw || {})){
      if (!moves) continue;
      const resolved = {};
      if (moves.fast){
        const fastMove = findMove(pool.fast, moves.fast);
        if (fastMove) resolved.fast = fastMove;
      }
      if (Array.isArray(moves.charged)){
        const chargedMoves = moves.charged.map(id=>findMove(pool.charged, id)).filter(Boolean);
        if (chargedMoves.length) resolved.charged = chargedMoves;
      }
      if (Object.keys(resolved).length){
        resolvedPerLeague[key] = resolved;
      }
    }
    const preferred = [];
    if (league && resolvedPerLeague[league]) preferred.push(league);
    if (rec.league && resolvedPerLeague[rec.league]) preferred.push(rec.league);
    if (rec.default && resolvedPerLeague[rec.default]) preferred.push(rec.default);
    for (const key of LEAGUE_PRIORITY){
      if (resolvedPerLeague[key]) preferred.push(key);
    }
    const uniquePreferred = Array.from(new Set(preferred));
    let selectedLeague = uniquePreferred.find(key => resolvedPerLeague[key]) || null;
    let fast = null;
    let charged = [];
    if (selectedLeague){
      const set = resolvedPerLeague[selectedLeague];
      if (set.fast) fast = set.fast;
      if (set.charged && set.charged.length) charged = set.charged.slice(0,2);
    }
    if (!fast && rec.fast){
      const fallbackFast = findMove(pool.fast, rec.fast);
      if (fallbackFast) fast = fallbackFast;
    }
    if (!charged.length && Array.isArray(rec.charged)){
      const fallbackCharged = rec.charged.map(id=>findMove(pool.charged, id)).filter(Boolean);
      if (fallbackCharged.length) charged = fallbackCharged.slice(0,2);
    }
    if (!fast){
      for (const key of LEAGUE_PRIORITY){
        const set = resolvedPerLeague[key];
        if (set?.fast){ fast = set.fast; break; }
      }
    }
    if (!charged.length){
      for (const key of LEAGUE_PRIORITY){
        const set = resolvedPerLeague[key];
        if (set?.charged?.length){ charged = set.charged.slice(0,2); break; }
      }
    }
    if (!fast) fast = pool.fast[0] || null;
    if (!charged.length) charged = pool.charged.slice(0,2);
    const highlightFast = new Set();
    const highlightCharged = new Set();
    if (selectedLeague && resolvedPerLeague[selectedLeague]){
      const set = resolvedPerLeague[selectedLeague];
      if (set.fast) highlightFast.add(set.fast.id);
      if (set.charged){ set.charged.forEach(m=>highlightCharged.add(m.id)); }
    }
    if (rec.fast){
      const fallbackFast = findMove(pool.fast, rec.fast);
      if (fallbackFast) highlightFast.add(fallbackFast.id);
    }
    if (Array.isArray(rec.charged)){
      rec.charged.forEach(id=>{
        const mv = findMove(pool.charged, id);
        if (mv) highlightCharged.add(mv.id);
      });
    }
    return {
      pool,
      fast,
      charged,
      league: selectedLeague,
      perLeague: resolvedPerLeague,
      highlightFast: Array.from(highlightFast),
      highlightCharged: Array.from(highlightCharged),
    };
  }
  function getActiveMoveset(p, league = currentLeague){
    const recommended = getRecommendedInfo(p, league);
    const pool = recommended.pool;
    let fast = recommended.fast;
    let charged = recommended.charged ? recommended.charged.slice(0,2) : [];
    const key = activeMovesKey(p, league);
    const stored = activeMovesState[key];
    if (stored){
      if (stored.fast){
        const move = findMove(pool.fast, stored.fast);
        if (move) fast = move;
      }
      if (Array.isArray(stored.charged)){
        const selected = stored.charged.map(id=>findMove(pool.charged, id)).filter(Boolean);
        if (selected.length) charged = selected.slice(0,2);
      }
    }
    if (!fast) fast = pool.fast[0] || null;
    if (!charged.length) charged = (recommended.charged || []).slice(0,2);
    if (!charged.length) charged = pool.charged.slice(0,2);
    return {
      fast,
      charged,
      pool,
      league,
      recommended,
      highlight: {
        fast: recommended.highlightFast,
        charged: recommended.highlightCharged,
      },
    };
  }
  function setActiveMoves(p, league, fastMove, chargedMoves){
    if (!p) return;
    const key = activeMovesKey(p, league);
    const payload = {};
    if (fastMove?.id) payload.fast = fastMove.id;
    const chargedIds = (chargedMoves || []).map(m=>m?.id).filter(Boolean);
    if (chargedIds.length) payload.charged = chargedIds.slice(0,2);
    if (!payload.fast && (!payload.charged || !payload.charged.length)){
      delete activeMovesState[key];
    } else {
      activeMovesState[key] = payload;
    }
    saveActiveMoves();
  }
  function powerScore(p){
    const s = p.stats || {};
    return (s.attack || 0) * 0.6 + (s.defense || 0) * 0.25 + (s.stamina || 0) * 0.15;
  }
  function stabBonus(attacker, moveType){
    return moveType && attacker.types?.includes(moveType) ? 1.2 : 1;
  }
  function moveMultiplier(moveType, defenderTypes){
    return moveType ? effectiveness(moveType, defenderTypes) : 1;
  }
  function scoreFastMove(move, attacker, defenderTypes){
    if (!move) return {score:0.5, mult:1, move:null};
    const mult = moveMultiplier(move.type, defenderTypes) * stabBonus(attacker, move.type);
    const cooldown = typeof move.cooldown === 'number' ? move.cooldown : (typeof move.cooldown_s === 'number' ? move.cooldown_s : null);
    let dps = typeof move.dps === 'number' ? move.dps : null;
    if (!dps && typeof move.power === 'number' && cooldown){ dps = move.power / cooldown; }
    if (!dps) dps = typeof move.power === 'number' ? move.power : 1;
    let eps = typeof move.eps === 'number' ? move.eps : null;
    if (!eps && typeof move.energy === 'number' && cooldown){ eps = move.energy / cooldown; }
    if (!eps) eps = typeof move.energy === 'number' ? move.energy : 0;
    const pressure = dps * 0.65 + eps * 0.35;
    return {score: pressure * mult, mult, move};
  }
  function scoreChargedMove(move, attacker, defenderTypes){
    if (!move) return {score:0.5, mult:1, move:null};
    const mult = moveMultiplier(move.type, defenderTypes) * stabBonus(attacker, move.type);
    const energyCost = Math.max(10, Math.abs(move.energy || 50));
    let dpe = typeof move.dpe === 'number' ? move.dpe : null;
    if (!dpe && typeof move.power === 'number'){ dpe = move.power / energyCost; }
    const powerBonus = 1 + (move.power || 0) / 200;
    const speedBonus = 1 + 40 / Math.max(35, energyCost);
    return {score: dpe * mult * powerBonus * speedBonus, mult, move};
  }
  function evaluatePokemonAgainst(attacker, defender, moveset){
    const chosen = moveset || getActiveMoveset(attacker, currentLeague);
    const fast = chosen.fast;
    const charged = chosen.charged || [];
    const defenderTypes = defender.types || [];
    const fastResult = scoreFastMove(fast, attacker, defenderTypes);
    const chargedResults = charged.map(m=>scoreChargedMove(m, attacker, defenderTypes));
    const bestCharged = chargedResults.sort((a,b)=>b.score-a.score)[0] || null;
    const coverage = new Set();
    if (fast?.type) coverage.add(fast.type);
    charged.forEach(m=>{ if (m?.type) coverage.add(m.type); });
    const coverageBonus = 1 + coverage.size * 0.03;
    const bulkBonus = 1 + powerScore(attacker)/400;
    const fastScore = fastResult.score;
    const chargedScore = bestCharged ? bestCharged.score : fastScore;
    const combined = (fastScore * 0.45 + chargedScore * 0.55) * coverageBonus * bulkBonus;
    const bestResult = !bestCharged || fastResult.score >= bestCharged.score ? fastResult : bestCharged;
    return {
      name: attacker.name,
      dex: attacker.dex,
      score: combined,
      mult: bestResult?.mult || 1,
      bestMove: bestResult?.move || null,
      bestMoveKind: bestResult === fastResult ? 'fast' : 'charged',
      fastMove: fast,
      chargedMoves: charged,
      types: attacker.types || [],
    };
  }
  function rankTeamAgainst(defender){
    const team = getTeam().map(name=>POKEMON.find(p=>p.name===name)).filter(Boolean);
    return team
      .map(p => {
        const moveset = getActiveMoveset(p, currentLeague);
        return evaluatePokemonAgainst(p, defender, moveset);
      })
      .sort((a,b)=>b.score-a.score);
  }
  function setSprite(imgEl, pokemon){
    if (!imgEl) return;
    if (!pokemon){
      imgEl.src = '';
      imgEl.alt = 'No image';
      imgEl.classList.add('no-sprite');
      return;
    }
    const dex = Number(pokemon.dex || 0);
    const slug = (pokemon.slug || pokemon.name || '').toString().toLowerCase();
    const num = String(dex).padStart(3,'0');
    const sanitizedSlug = slug.replace(/[^a-z0-9-]/g,'');
    const specialSprites = (typeof window !== 'undefined' && window.MEGA_ORIGIN_SPRITES) ? window.MEGA_ORIGIN_SPRITES : null;
    const specialSource = specialSprites && (specialSprites[sanitizedSlug] || specialSprites[slug]);
    if (specialSource){
      imgEl.onerror = null;
      imgEl.src = specialSource;
      imgEl.alt = pokemon.name || 'Pokémon';
      imgEl.classList.remove('no-sprite');
      return;
    }
    const preferSlugArt = Boolean(sanitizedSlug && sanitizedSlug.includes('-'));
    const localSlugSources = sanitizedSlug ? [
      `sprites/${sanitizedSlug}.png`,
      `sprites/${sanitizedSlug}.webp`,
      `sprites/${num}-${sanitizedSlug}.png`,
      `sprites/${num}-${sanitizedSlug}.webp`,
    ].filter(Boolean) : [];
    const localBaseSources = [
      `sprites/${num}.png`,
      `sprites/${num}.webp`,
    ];
    const remoteEnabled = typeof window !== 'undefined' && window.POKEDEX_ENABLE_REMOTE_SPRITES === true;
    const remoteSlugSources = remoteEnabled && sanitizedSlug ? [
      `https://img.pokemondb.net/sprites/home/normal/${sanitizedSlug}.png`,
      sanitizedSlug.endsWith('-shadow') ? `https://img.pokemondb.net/sprites/home/normal/${sanitizedSlug.replace(/-shadow$/, '')}.png` : null,
      sanitizedSlug.endsWith('-purified') ? `https://img.pokemondb.net/sprites/home/normal/${sanitizedSlug.replace(/-purified$/, '')}.png` : null,
    ].filter(Boolean) : [];
    const remoteBaseSources = remoteEnabled && dex ? [
      `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${dex}.png`,
      `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${dex}.png`,
    ] : [];
    const combined = preferSlugArt
      ? [...localSlugSources, ...localBaseSources, ...remoteSlugSources, ...remoteBaseSources]
      : [...localBaseSources, ...localSlugSources, ...remoteBaseSources, ...remoteSlugSources];
    const sources = combined.filter(Boolean);
    const uniqueSources = [];
    for (const src of sources){ if (!uniqueSources.includes(src)) uniqueSources.push(src); }
    let index = 0;
    const tryNext = ()=>{
      if (index >= uniqueSources.length){
        imgEl.onerror = null;
        imgEl.src = '';
        imgEl.alt = 'No image available';
        imgEl.classList.add('no-sprite');
        return;
      }
      const next = uniqueSources[index++];
      imgEl.onerror = tryNext;
      imgEl.src = next;
      imgEl.alt = pokemon.name || 'Pokémon';
    };
    imgEl.onload = ()=>{ imgEl.onerror = null; imgEl.classList.remove('no-sprite'); };
    tryNext();
  }
  function renderMoveOptions(container, moves, { pokemon, league, category, selectedIds = [], recommendedIds = [], maxSelect = 1 } = {}){
    if (!container) return;
    if (!moves || !moves.length){
      container.textContent = '–';
      container.dataset.category = category || '';
      container.dataset.pokemonSlug = pokemon?.slug || '';
      container.dataset.league = league || currentLeague;
      return;
    }
    container.innerHTML = '';
    container.dataset.category = category || '';
    container.dataset.pokemonSlug = pokemon?.slug || '';
    container.dataset.league = league || currentLeague;
    container.dataset.maxSelect = String(maxSelect);
    if (!container._moveHandlerAttached){
      container.addEventListener('click', onMoveOptionClick);
      container._moveHandlerAttached = true;
    }
    const selectedSet = new Set((selectedIds || []).map(id=>String(id)));
    const recommendedSet = new Set((recommendedIds || []).map(id=>String(id)));
    for (const move of moves){
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.dataset.moveId = move.id;
      btn.textContent = describeMove(move);
      if (selectedSet.has(move.id)) btn.classList.add('active');
      if (recommendedSet.has(move.id)) btn.classList.add('recommended');
      container.appendChild(btn);
    }
  }
  function onMoveOptionClick(event){
    const target = event.target.closest('button[data-move-id]');
    if (!target) return;
    const container = target.closest('.moves-list');
    if (!container) return;
    const moveId = target.dataset.moveId;
    const category = container.dataset.category || 'fast';
    const league = container.dataset.league || currentLeague;
    const slug = container.dataset.pokemonSlug;
    const pokemon = getPokemonBySlug(slug) || byName(slug);
    if (!pokemon) return;
    const moveset = getActiveMoveset(pokemon, league);
    if (category === 'fast'){
      const fastMove = findMove(moveset.pool.fast, moveId);
      if (!fastMove) return;
      setActiveMoves(pokemon, league, fastMove, moveset.charged);
    } else {
      const chargedMove = findMove(moveset.pool.charged, moveId);
      if (!chargedMove) return;
      const maxSelect = Number(container.dataset.maxSelect || 2);
      const current = moveset.charged.slice();
      const existingIndex = current.findIndex(m => m?.id === chargedMove.id);
      if (existingIndex >= 0){
        current.splice(existingIndex, 1);
      } else {
        if (current.length >= maxSelect){
          current.shift();
        }
        current.push(chargedMove);
      }
      setActiveMoves(pokemon, league, moveset.fast, current);
    }
    if (league === currentLeague){
      if (currentPokemon && currentPokemon.slug === (pokemon.slug || '')){
        showPokemon(pokemon);
      } else if (currentPokemon){
        renderRankings(rankTeamAgainst(currentPokemon));
      }
    }
    renderTeam();
  }
  function renderFeaturedMoves(pokemon, recommended){
    if (!featuredMovesEl) return;
    featuredMovesEl.innerHTML = '';
    if (!recommended){
      featuredMovesEl.textContent = 'No PvPoke recommendations found.';
      return;
    }
    let added = false;
    if (recommended.perLeague){
      for (const key of LEAGUE_PRIORITY){
        const set = recommended.perLeague[key];
        if (!set) continue;
        added = true;
        const row = document.createElement('div');
        row.className = 'featured-row';
        if (key === (recommended.league || currentLeague)) row.classList.add('active');
        const fastText = set.fast ? describeMove(set.fast) : '–';
        const chargedText = set.charged && set.charged.length ? set.charged.map(describeMove).join(', ') : '–';
        row.innerHTML = `<span class="label">${leagueLabel(key)}</span><div>Fast: ${fastText}</div><div>Charged: ${chargedText}</div>`;
        featuredMovesEl.appendChild(row);
      }
    }
    if (!added){
      const fastMove = recommended.fast ? describeMove(recommended.fast) : '–';
      const chargedMoves = recommended.charged && recommended.charged.length ? recommended.charged.map(describeMove).join(', ') : '–';
      const row = document.createElement('div');
      row.className = 'featured-row active';
      row.innerHTML = `<span class="label">Default</span><div>Fast: ${fastMove}</div><div>Charged: ${chargedMoves}</div>`;
      featuredMovesEl.appendChild(row);
    }
  }

  // ------------------ Render ------------------
  function showPokemon(p){
    if (!p || p.released === false){
      currentPokemon = null;
      if (emptyState){
        emptyState.textContent = p && p.released === false
          ? 'This Pokémon has not been released in Pokémon GO.'
          : DEFAULT_EMPTY_TEXT;
        emptyState.classList.remove('hidden');
      }
      if (resultEl) resultEl.classList.add('hidden');
      return;
    }
    currentPokemon = p;
    if (emptyState){
      emptyState.textContent = DEFAULT_EMPTY_TEXT;
      emptyState.classList.add('hidden');
    }
    resultEl.classList.remove('hidden');
    if (emptyState) emptyState.classList.add('hidden');
    titleEl.textContent = `${p.name} #${String(p.dex).padStart(3,'0')}`;
    typesEl.innerHTML = formatTypes(p.types);
    setSprite(spriteEl, p);
    const mults = defendMultipliers(p.types);
    const {weak,res,imm} = listFromMults(mults);
    weakEl.textContent = weak.join(', ') || '–';
    resEl.textContent = res.join(', ') || '–';
    immEl.textContent = imm.join(', ') || '–';
    const stats = p.stats || {};
    statsEl.textContent = stats.attack ? `ATK ${stats.attack} · DEF ${stats.defense} · STA ${stats.stamina}` : '–';
    const moveset = getActiveMoveset(p, currentLeague);
    const selectedFast = moveset.fast ? [moveset.fast.id] : [];
    const selectedCharged = (moveset.charged || []).map(m=>m.id);
    renderMoveOptions(fastMovesEl, moveset.pool.fast, {
      pokemon: p,
      league: currentLeague,
      category: 'fast',
      selectedIds: selectedFast,
      recommendedIds: moveset.highlight.fast,
      maxSelect: 1,
    });
    renderMoveOptions(chargedMovesEl, moveset.pool.charged, {
      pokemon: p,
      league: currentLeague,
      category: 'charged',
      selectedIds: selectedCharged,
      recommendedIds: moveset.highlight.charged,
      maxSelect: 2,
    });
    renderFeaturedMoves(p, moveset.recommended);
    vsName.textContent = `${p.name} (${leagueShort(currentLeague)} League)`;
    renderRankings(rankTeamAgainst(p));
  }
  function renderRankings(rows){
    rankingsEl.innerHTML = '';
    if (!rows.length){
      const div = document.createElement('div');
      div.className = 'hint';
      div.textContent = 'Add Pokémon to your team to see rankings.';
      rankingsEl.appendChild(div);
      return;
    }
    rows.forEach((r,i)=>{
      const el = document.createElement('div');
      el.className = 'rank-item';
      const bestLabel = r.bestMoveKind === 'charged' ? 'Best charged' : 'Best fast';
      const bestMoveText = describeMove(r.bestMove);
      const fastText = describeMove(r.fastMove);
      const chargedText = (r.chargedMoves && r.chargedMoves.length) ? r.chargedMoves.map(describeMove).join(', ') : '–';
      el.innerHTML = `
        <div class="l">
          <div class="dot" style="opacity:${1 - i*0.2}"></div>
          <div>
            <b>${i+1}. ${r.name}</b>
            <div class="types">${formatTypes(r.types)}</div>
          </div>
        </div>
        <div class="r">
          <div class="top">
            <span class="pill">${bestLabel}: ${bestMoveText}</span>
            <span class="pill">League: ${leagueShort(currentLeague)}</span>
            <span class="pill">x${r.mult.toFixed(2)}</span>
            <span class="score">${r.score.toFixed(1)}</span>
          </div>
          <div class="team-moves small">
            <div><span class="label">Fast</span>${fastText}</div>
            <div><span class="label">Charged</span>${chargedText}</div>
          </div>
        </div>`;
      rankingsEl.appendChild(el);
    });
  }
  function renderTeamSummary(){
    if (!teamSummaryContent) return;
    teamSummaryContent.innerHTML = '';
    const teamNames = getTeam();
    const resolved = teamNames
      .map(name => POKEMON.find(p => p && p.name === name && p.released !== false))
      .filter(Boolean);
    const missingCount = teamNames.length - resolved.length;
    if (!resolved.length){
      const empty = document.createElement('div');
      empty.className = 'hint';
      empty.textContent = 'Add Pokémon to your team to explore combined weaknesses and resistances.';
      teamSummaryContent.appendChild(empty);
      return;
    }
    const intro = document.createElement('div');
    intro.className = 'team-summary-intro';
    intro.innerHTML = `<p>Current team (<strong>${resolved.length}</strong>/3) for ${leagueLabel(currentLeague)}.</p>`;
    const teamRow = document.createElement('div');
    teamRow.className = 'team-summary-team';
    resolved.forEach(p => {
      const item = document.createElement('div');
      item.className = 'team-summary-team-member';
      item.innerHTML = `<img alt="${p.name}" class="summary-thumb" /><span>${p.name}</span>`;
      teamRow.appendChild(item);
      const img = item.querySelector('img');
      if (img) setSprite(img, p);
    });
    intro.appendChild(teamRow);
    teamSummaryContent.appendChild(intro);
    if (missingCount > 0){
      const warn = document.createElement('div');
      warn.className = 'team-summary-warning';
      warn.textContent = `${missingCount} team Pokémon are unavailable in the dataset and were skipped.`;
      teamSummaryContent.appendChild(warn);
    }
    const coverageSection = document.createElement('section');
    coverageSection.className = 'team-coverage';
    coverageSection.innerHTML = '<h3>Coverage overview</h3>';
    const grid = document.createElement('div');
    grid.className = 'team-coverage-grid';
    coverageSection.appendChild(grid);
    const coverageEntries = TYPES.map(type => ({
      type,
      label: typeLabel(type),
      color: typeColor(type),
      weak: 0,
      resist: 0,
      immune: 0,
    }));
    const coverageMap = new Map(coverageEntries.map(entry => [entry.type, entry]));
    resolved.forEach(p => {
      const mults = defendMultipliers(p.types || []);
      TYPES.forEach(type => {
        const entry = coverageMap.get(type);
        if (!entry) return;
        const mult = mults[type];
        if (mult === 0) entry.immune += 1;
        else if (mult > 1) entry.weak += 1;
        else if (mult < 1) entry.resist += 1;
      });
    });
    coverageEntries.forEach(entry => {
      const card = document.createElement('div');
      card.className = 'coverage-card';
      if (!entry.weak && !entry.resist && !entry.immune) card.classList.add('muted');
      card.innerHTML = `
        <div class="type-chip-row"><span class="type-chip" style="--type-color:${entry.color}">${entry.label}</span></div>
        <div class="coverage-counts">
          <span class="coverage-count weak${entry.weak ? ' has-value' : ''}"><span>Weak</span><strong>${entry.weak}</strong></span>
          <span class="coverage-count resist${entry.resist ? ' has-value' : ''}"><span>Resist</span><strong>${entry.resist}</strong></span>
          <span class="coverage-count immune${entry.immune ? ' has-value' : ''}"><span>Immune</span><strong>${entry.immune}</strong></span>
        </div>`;
      grid.appendChild(card);
    });
    teamSummaryContent.appendChild(coverageSection);
    const detailSection = document.createElement('section');
    detailSection.className = 'team-breakdown';
    detailSection.innerHTML = '<h3>Individual breakdown</h3>';
    const detailGrid = document.createElement('div');
    detailGrid.className = 'team-breakdown-grid';
    detailSection.appendChild(detailGrid);
    resolved.forEach(p => {
      const breakdown = breakdownMultipliers(defendMultipliers(p.types || []));
      const card = document.createElement('article');
      card.className = 'team-breakdown-card';
      card.innerHTML = `
        <div class="card-head">
          <img class="summary-thumb" alt="${p.name}" />
          <div>
            <div class="card-title">${p.name}</div>
            <div class="types">${formatTypes(p.types || [])}</div>
          </div>
        </div>
        <div class="card-body">
          <div><span class="label">Weak to</span><div class="type-chip-row">${renderTypeChipList(breakdown.weak, 'weak')}</div></div>
          <div><span class="label">Resists</span><div class="type-chip-row">${renderTypeChipList(breakdown.res, 'resist')}</div></div>
          <div><span class="label">Immune to</span><div class="type-chip-row">${renderTypeChipList(breakdown.imm, 'immune')}</div></div>
        </div>`;
      detailGrid.appendChild(card);
      const img = card.querySelector('img.summary-thumb');
      if (img) setSprite(img, p);
    });
    teamSummaryContent.appendChild(detailSection);
  }
  function isTeamSummaryOpen(){
    return Boolean(teamSummaryPanel && teamSummaryPanel.classList.contains('visible'));
  }
  function openTeamSummary(){
    if (!teamSummaryPanel || !teamSummaryBtn || teamSummaryBtn.disabled) return;
    renderTeamSummary();
    teamSummaryPanel.classList.remove('hidden');
    teamSummaryPanel.classList.add('visible');
    teamSummaryPanel.setAttribute('aria-hidden', 'false');
    teamSummaryBtn.setAttribute('aria-expanded', 'true');
    const focusTarget = teamSummaryPanel.querySelector('.team-summary__card');
    if (focusTarget && typeof focusTarget.focus === 'function'){
      focusTarget.focus();
    }
  }
  function closeTeamSummary(){
    if (!teamSummaryPanel) return;
    teamSummaryPanel.classList.remove('visible');
    teamSummaryPanel.classList.add('hidden');
    teamSummaryPanel.setAttribute('aria-hidden', 'true');
    if (teamSummaryBtn){
      teamSummaryBtn.setAttribute('aria-expanded', 'false');
    }
  }
  function populateSelectors(){
    const pool = RELEASED_POKEMON.length ? RELEASED_POKEMON : POKEMON;
    const sorted = [...pool].sort((a,b)=>a.name.localeCompare(b.name));
    for (const sel of [nameSelect, teamSelect]){
      sel.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = '— choose —';
      sel.appendChild(opt0);
      sorted.forEach(p=>{
        const o = document.createElement('option');
        o.value = p.name; o.textContent = p.name; sel.appendChild(o);
      });
    }
    if (currentPokemon && nameSelect){
      nameSelect.value = currentPokemon.name;
    }
  }
  function pickRandomPokemon(){
    const pool = RELEASED_POKEMON.length ? RELEASED_POKEMON : POKEMON;
    if (!pool.length) return null;
    const randomIndex = Math.floor(Math.random() * pool.length);
    return pool[randomIndex] || null;
  }
  function populateLeagueSelector(){
    if (!leagueSelect) return;
    leagueSelect.innerHTML = '';
    LEAGUES.forEach(info => {
      const opt = document.createElement('option');
      opt.value = info.key;
      opt.textContent = info.label;
      leagueSelect.appendChild(opt);
    });
    if (!LEAGUE_PRIORITY.includes(currentLeague)){
      currentLeague = LEAGUE_PRIORITY[0];
    }
    leagueSelect.value = currentLeague;
  }
  function getTeam(){
    try { return JSON.parse(localStorage.getItem('team3')||'[]'); } catch { return []; }
  }
  function setTeam(arr){
    try { localStorage.setItem('team3', JSON.stringify(arr.slice(0,3))); } catch {}
    renderTeam();
  }
  function renderTeam(){
    const t = getTeam();
    teamSlots.innerHTML = '';
    let hasValid = false;
    for (let i=0;i<3;i++){
      const name = t[i];
      const slot = document.createElement('div');
      slot.className = 'slot';
      if (name){
        slot.classList.add('filled');
        const p = POKEMON.find(x=>x.name===name);
        if (!p || p.released === false){
          slot.innerHTML = `
            <div class="team-entry">
              <div class="team-entry__content">
                <b>${name}</b>
                <div class="hint">Data not available (unreleased or missing from dataset).</div>
              </div>
              <div class="team-actions">
                <button type="button" class="ghost danger" onclick="removeFromTeam(${i})">Remove</button>
              </div>
            </div>`;
        } else {
          hasValid = true;
          const moveset = getActiveMoveset(p, currentLeague);
          const fastText = moveset.fast ? describeMove(moveset.fast) : '–';
          const chargedText = moveset.charged && moveset.charged.length ? moveset.charged.map(describeMove).join(', ') : '–';
          slot.innerHTML = `
            <div class="team-entry">
              <img class="team-thumb" alt="${p.name}" />
              <div class="team-entry__content">
                <b>${p.name}</b>
                <div class="types">${formatTypes(p.types)}</div>
                <div class="team-moves">
                  <div><span class="label">Fast (${leagueShort(currentLeague)})</span>${fastText}</div>
                  <div><span class="label">Charged</span>${chargedText}</div>
                </div>
              </div>
              <div class="team-actions">
                <button type="button" class="ghost team-edit" data-slug="${p.slug}">Edit moves</button>
                <button type="button" class="ghost danger" onclick="removeFromTeam(${i})">Remove</button>
              </div>
            </div>`;
          const img = slot.querySelector('img.team-thumb');
          if (img) setSprite(img, p);
          const editBtn = slot.querySelector('button.team-edit');
          if (editBtn){
            editBtn.onclick = ()=>{
              nameInput.value = p.name;
              nameSelect.value = p.name;
              showPokemon(p);
              try {
                window.scrollTo({ top: 0, behavior: 'smooth' });
              } catch {}
            };
          }
        }
      } else {
        slot.textContent = 'Empty';
      }
      teamSlots.appendChild(slot);
    }
    if (teamSummaryBtn){
      teamSummaryBtn.disabled = !hasValid;
      teamSummaryBtn.setAttribute('aria-disabled', hasValid ? 'false' : 'true');
    }
    if (!hasValid && isTeamSummaryOpen()){
      closeTeamSummary();
    }
    renderTeamSummary();
  }
  function removeFromTeam(i){
    const t = getTeam();
    t.splice(i,1);
    setTeam(t);
  }
  window.removeFromTeam = removeFromTeam; // expose for inline onclick

  // ------------------ Voice (Electron disabled) ------------------
  let rec; let recActive = false;
  function setupVoice(){
    const R = window.SpeechRecognition || window.webkitSpeechRecognition;
    const isElectron = typeof navigator !== 'undefined' && /Electron/i.test(navigator.userAgent || '');
    // Update hint text
    if (voiceHintEl){
      voiceHintEl.textContent = isElectron
        ? 'Voice search is unavailable in the desktop app. Use typing or the dropdown.'
        : 'Voice tips: Press and hold the mic, say the name (e.g., pikachu), release. Works best in Chrome / Edge.';
    }
    // Disable if Electron OR unsupported
    if (isElectron || !R){
      voiceBtn.disabled = true;
      voiceBtn.classList.add('disabled');
      voiceBtn.title = isElectron
        ? 'Voice search isn’t available in the desktop app'
        : 'Speech recognition not supported in this browser';
      voiceLabel.textContent = isElectron ? 'Unavailable in desktop app' : 'Not supported';
      return;
    }
    // Browser speech setup
    rec = new R();
    rec.lang = 'en-US';
    rec.interimResults = false;
    rec.maxAlternatives = 4;
    rec.onresult = (e)=>{
      const alts = [];
      for (const r of e.results){ for (const a of r){ alts.push(a.transcript); } }
      let found = null;
      for (const t of alts){ found = byName(t); if (found) break; }
      if (!found){
        const cleaned = alts.map(s=>s.toLowerCase().replace(/[^a-z0-9 ]/g,'').trim());
        for (const t of cleaned){ found = byName(t); if (found) break; }
      }
      if (found){
        nameInput.value = found.name; nameSelect.value = found.name;
        showPokemon(found);
      } else {
        alert('Did not catch that name. Try again or type/select.');
      }
    };
    rec.onend = ()=>{
      recActive=false; voiceLabel.textContent='Hold to speak'; voiceBtn.classList.remove('rec');
    };
    const startRec = ()=>{ if (recActive) return; recActive=true; voiceLabel.textContent='Listening…'; voiceBtn.classList.add('rec'); rec.start(); };
    const stopRec  = ()=>{ if (!recActive) return; rec.stop(); };
    voiceBtn.onmousedown = startRec;
    voiceBtn.onmouseup = stopRec;
    voiceBtn.onmouseleave = stopRec;
    // Touch support
    voiceBtn.ontouchstart = (e)=>{ e.preventDefault(); startRec(); };
    voiceBtn.ontouchend = (e)=>{ e.preventDefault(); stopRec(); };
  }

  // ------------------ Events ------------------
  if (randomBtn){
    randomBtn.onclick = ()=>{
      const random = pickRandomPokemon();
      if (!random) return;
      nameInput.value = random.name;
      if (nameSelect) nameSelect.value = random.name;
      showPokemon(random);
    };
  }
  nameSelect.onchange = ()=>{
    const v = nameSelect.value; if (!v) return; nameInput.value = v; const p=byName(v); showPokemon(p);
  };
  addToTeamBtn.onclick = ()=>{
    const sel = teamSelect.value; if (!sel) return;
    const t = getTeam();
    if (t.includes(sel)) return alert('Already on team.');
    if (t.length >= 3) return alert('Team is full (max 3). Remove one first.');
    t.push(sel); setTeam(t);
  };
  if (leagueSelect){
    leagueSelect.onchange = ()=>{
      const value = leagueSelect.value;
      currentLeague = LEAGUE_PRIORITY.includes(value) ? value : LEAGUE_PRIORITY[0];
      try { localStorage.setItem(LEAGUE_STORAGE_KEY, currentLeague); } catch {}
      renderTeam();
      if (currentPokemon){
        showPokemon(currentPokemon);
      }
    };
  }
  if (teamSummaryBtn){
    teamSummaryBtn.addEventListener('click', ()=>{
      if (teamSummaryBtn.disabled) return;
      openTeamSummary();
    });
  }
  if (closeTeamSummaryBtn){
    closeTeamSummaryBtn.addEventListener('click', ()=>{
      closeTeamSummary();
      if (teamSummaryBtn && typeof teamSummaryBtn.focus === 'function'){ teamSummaryBtn.focus(); }
    });
  }
  if (teamSummaryPanel){
    teamSummaryPanel.addEventListener('click', (event)=>{
      if (event.target === teamSummaryPanel){
        closeTeamSummary();
        if (teamSummaryBtn && typeof teamSummaryBtn.focus === 'function'){ teamSummaryBtn.focus(); }
      }
    });
  }
  document.addEventListener('keydown', (event)=>{
    if (event.key === 'Escape' && isTeamSummaryOpen()){
      event.preventDefault();
      closeTeamSummary();
      if (teamSummaryBtn && typeof teamSummaryBtn.focus === 'function'){ teamSummaryBtn.focus(); }
    }
  });

  // ------------------ Boot ------------------
  (async function(){
    await tryLoadExternalData();
    populateSelectors();
    populateLeagueSelector();
    renderTeam();
    setupVoice();
  })();
  </script>
</body>
</html>
